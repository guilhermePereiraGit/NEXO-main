<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Página de Cadastros de Totens</title>
    <link rel="shortcut icon" href="assets/favicon.ico" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="./css/gestor_unificado.css">

    <style>
        /* --- GARANTIAS DE CSS (Para não quebrar o layout) --- */
        
        /* X de fechar o popup (Canto superior direito) */
        .popup-cadastro .fechar-popup {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 30px;
            color: var(--principal);
            cursor: pointer;
            z-index: 2005;
        }

        /* Lixeira dos Parâmetros (Dentro do Popup) */
        .item-da-lista .bi-trash3 {
            position: static !important;
            margin-bottom: 10px;
            color: var(--principal) !important; 
            cursor: pointer;
        }
        
        /* Lixeira do Card (Na lista de modelos) */
        .icon-deletar {
            color: var(--principal) !important; /* Roxo */
            align-self: flex-end; /* Alinha a direita */
            cursor: pointer;
        }
    </style>
</head>

<body onload="carregarDadosUser(); carregarDadosAprovados()">

    <div class="tudo">
        <header>
            <div class="header-container">
                <div class="header-menu">
                    <div class="menu" id="menu" onclick="abrirMenu()">
                        <i class="bi bi-list" id="icone"></i>
                    </div>
                </div>

                <div class="header-navigation">
                    <div class="home">
                        <div class="fundo" style="display: block;"></div>
                        <i class="bi bi-house" onclick="window.location.reload()" style="color: #451c8b;"></i>
                    </div>
                    <div class="eficiencia">
                        <div class="fundo" style="display: none;"></div>
                        <i class="bi bi-eye" onclick="window.location.href = 'dashboard/gestor/silva/modelos.html'"></i>
                    </div>
                    <div class="eficiencia">
                        <div class="fundo" style="display: none;"></div>
                        <i class="bi bi-clipboard-data"
                            onclick="window.location.href = '../gabriel/eficiencia.html'"></i>
                    </div>
                    <div class="sair">
                        <div class="fundo" style="display: none;"></div>
                        <i class="bi bi-box-arrow-left" onclick="ativarPopup()"></i>
                    </div>
                </div>

                <div class="header-help">
                    <i class="bi bi-info-circle" onclick="abrirPassos()"></i>
                </div>
            </div>

            <div class="menu-extend" style="display: none;" id="extend">
                <div class="infos-user">
                    <h1 id="nome_user"></h1>
                    <h2>Gestor de Operações</h2>
                </div>
                <div class="widgets">
                    <p>Caso se depare com algum problema, entre em contato via:</p>
                    <div class="email" style="margin-top: 20px;">
                        <i class="bi bi-envelope"></i>
                        <p>Email: nexoadm9328@outlook.com</p>
                    </div>
                    <div class="telefone" style="margin-top: 20px;">
                        <i class="bi bi-telephone"></i>
                        <p>Telefone: +55(11)98802-2449</p>
                    </div>
                </div>
                <div class="jira-slack">
                    <div class="card"
                        onclick="window.location.href='https://nexoadm.atlassian.net/jira/servicedesk/projects/NEXO/summary?ignoreStickyVersion=true'">
                        <img src="assets/imgs/icon-jira.png">
                        <h1>Jira</h1>
                    </div>
                    <div class="card"
                        onclick="window.location.href='https://app.slack.com/client/T09LFRM7PFX/C09LH8XJS22'">
                        <img src="assets/imgs/icon-slack.png">
                        <h1>Slack</h1>
                    </div>
                </div>
            </div>
        </header>

        <div class="popup-logout" style="display: none;" id="popup-logout">
            <div class="popup-content">
                <i class="bi bi-x-lg" onclick="fecharPopup()"></i>
                <h1>Deseja Sair?</h1>
                <div class="box-button">
                    <button onclick="limparSessao()">Fazer Logout</button>
                </div>
            </div>
        </div>

        <div class="popup-passos" style="display: none;" id="popup-passos">
            <div class="passos-content">
                <i class="bi bi-x-lg" onclick="fecharPassos()"
                    style="float: right; font-size: 30px; color: #451c8b; cursor: pointer;"></i>
                <h1 style="text-align: center; color: #451c8b; margin-top: 40px;">Ajuda</h1>
                <p style="margin-top: 20px; text-align: center;">Área de gerenciamento de modelos de totens.</p>
            </div>
        </div>

        <div class="content">
            <div class="information">
                <div class="title">
                    <p>Modelos Cadastrados</p>
                </div>
                <div class="alterar-regiao">
                    <button onclick="abrirPopupModelo()">Adicionar Modelo</button>
                </div>
            </div>

            <div class="conteudo" id="conteudo">
                <div class="div_aprovados" id="div_aprovados"></div>
            </div>
        </div>

    </div>

    <div class="popup-cadastro" id="popupmodelo" style="display: none;">
        <div class="cadastro-content">
            <i class="bi bi-x-lg fechar-popup" onclick="fecharPopupModelo()"></i>
            
            <h1 id="popup_titulo" style="text-align: center; margin-bottom: 20px;">Cadastro de Modelo</h1>

            <div class="infos">
                <div class="infos-first">
                    <div class="drop">
                        <h2>Nome</h2>
                        <input type="text" id="input_nome_modelo">
                    </div>
                    <div class="drop">
                        <h2>Descrição</h2>
                        <input type="text" id="input_descricao">
                    </div>
                </div>

                <h1 style="margin-top: 20px; font-size: 18px; color: var(--principal); font-weight: 500;">Métricas de
                    Monitoramento:</h1>
                <p class="info-default">
                    Ao selecionar uma métrica e clicar em <strong><u>Adicionar Parâmetro</u></strong>, um valor padrão
                    será sugerido.
                    Para CPU, RAM e Disco, este é o <strong><u>percentual máximo de uso</u></strong>.
                    Para Processos, é a <strong><u>contagem total</u></strong>.
                </p>

                <div class="infos-third" id="linha-input-estatica">
                    <div class="drop" style="width: 60%;">
                        <select id="componente_master" class="componentes" onchange="definirDefault(this)">
                            <option value="">Selecione para adicionar...</option>
                        </select>
                        <input type="hidden" id="limite_master">
                    </div>
                    <div class="drop" style="width: 40%;">
                        <button class="cadastrar" id="btn_adicionar_parametro" onclick="adicionarParametro()"
                            style="background-color: var(--fundo); color: var(--principal); border: 1px solid var(--principal);"
                            disabled>Adicionar Parâmetro</button>
                    </div>
                </div>

                <div class="parametros-scroll" id="parametros-container">
                </div>
            </div>

            <div class="infos-final" style="margin-top: 20px;">
                <div class="drop" style="width: 100%;">
                    <button class="cadastrar" id="popup_button" onclick="cadastrarModelo()">Cadastrar Modelo</button>
                </div>
            </div>
        </div>
    </div>

</body>

<script>
    // --- FUNÇÕES DE MENU E INTERFACE ---
    function abrirMenu() {
        var menu_icon = document.getElementById('icone');
        var menu = document.querySelector('.menu-extend');

        if (menu_icon.classList.contains("bi-list")) {
            document.getElementById('extend').style.display = "flex";
            menu.style.animation = "expandirDireita 0.5s ease forwards";
            menu_icon.classList.remove("bi-list");
            menu_icon.classList.add("bi-x-lg");
        } else {
            menu.style.animation = "recolherEsquerda 0.5s ease forwards";
            menu_icon.classList.remove("bi-x-lg");
            menu_icon.classList.add("bi-list");
        }
    }

    function carregarDadosUser() {
        var nome = sessionStorage.getItem('NOME_USUARIO');
        if (nome != null) {
            document.getElementById('nome_user').innerHTML = nome;
        } else {
            document.getElementById('nome_user').innerHTML = "Usuário";
        }
    }

    function ativarPopup() {
        var popup = $("#popup-logout");
        popup.css({ display: "flex", opacity: 0, "pointer-events": "auto" }).animate({ opacity: 1 }, 300);
    }

    function fecharPopup() {
        var popup = $("#popup-logout");
        popup.css({ display: "flex", opacity: 0, "pointer-events": "none" }).animate({ opacity: 0 }, 300);
    }

    function abrirPassos() {
        var popup = $("#popup-passos");
        popup.css({ display: "flex", opacity: 0, "pointer-events": "auto" }).animate({ opacity: 1 }, 300);
    }

    function fecharPassos() {
        var popup = $("#popup-passos");
        popup.css({ display: "flex", opacity: 0, "pointer-events": "none" }).animate({ opacity: 0 }, 300);
    }

    function limparSessao() {
        sessionStorage.clear();
        window.location.href = 'login.html';
    }

    // --- VARIÁVEIS GLOBAIS ---
    var valoresDefault = [];
    var aprovados = [];
    var indiceParametro = 0;

    // --- FUNÇÕES DO POPUP DE MODELO ---
    function abrirPopupTela() {
        var popup = $("#popupmodelo");
        popup.css({
            display: "flex",
            opacity: 0,
            "pointer-events": "auto"
        }).animate({ opacity: 1 }, 300);
    }

    function abrirPopupModelo() {
        document.getElementById('input_nome_modelo').value = "";
        document.getElementById('input_descricao').value = "";
        document.getElementById('btn_adicionar_parametro').disabled = true;
        document.getElementById('parametros-container').innerHTML = "";
        indiceParametro = 0;

        document.getElementById('popup_titulo').innerText = "Cadastro de Modelo";
        var btn = document.getElementById('popup_button');
        btn.innerText = "Cadastrar Modelo";
        btn.onclick = cadastrarModelo;

        var idEmpresa = sessionStorage.getItem("FK_EMPRESA");

        fetch("/modelo/buscarDefaults", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ fkEmpresaServer: idEmpresa })
        })
        .then(function (resposta) {
            if (resposta.ok) {
                resposta.json().then(function (data) {
                    valoresDefault = data;
                    carregarSelectMetricas();
                    abrirPopupTela();
                });
            } else {
                valoresDefault = [];
                carregarSelectMetricas();
                abrirPopupTela();
            }
        })
        .catch(function () {
            valoresDefault = [];
            carregarSelectMetricas();
            abrirPopupTela();
        });
    }

    function fecharPopupModelo() {
        var popup = $("#popupmodelo");
        popup.css({ display: "flex", opacity: 1, "pointer-events": "none" }).animate({ opacity: 0 }, 300);
    }

    function definirDefault(selectElement) {
        var valorSelecionado = selectElement.value.toLowerCase();
        var limiteInput = document.getElementById('limite_master');
        var btnAdicionar = document.getElementById('btn_adicionar_parametro');

        if (valorSelecionado == "") {
            btnAdicionar.disabled = true;
            limiteInput.value = "";
            return;
        }

        var j = 0;
        var encontrou = false;
        for (j = 0; j < valoresDefault.length; j++) {
            if (valoresDefault[j].componente == valorSelecionado) {
                limiteInput.value = valoresDefault[j].valor;
                encontrou = true;
            }
        }

        if (encontrou == false) {
            limiteInput.value = "";
        }

        btnAdicionar.disabled = false;
    }

    function carregarSelectMetricas() {
        var select = document.getElementById('componente_master');
        var opcoes = '<option value="">Selecione para adicionar...</option>';

        if (valoresDefault.length == 0) {
            select.innerHTML = opcoes;
            return;
        }

        for (var i = 0; i < valoresDefault.length; i++) {
            var item = valoresDefault[i];
            opcoes += '<option value="' + item.componente.toLowerCase() + '">' + item.componente.toUpperCase() + '</option>';
        }

        select.innerHTML = opcoes;
    }

    function adicionarParametro(componentePreenchido, limitePreenchido) {
        var componente;

        if (componentePreenchido != null) {
            componente = componentePreenchido;
        } else {
            componente = document.getElementById('componente_master').value;
        }

        if (componente == "") {
            alert("Selecione uma métrica antes de adicionar.");
            return;
        }

        componente = componente.toLowerCase();

        for (var i = 0; i <= indiceParametro; i++) {
            var compInput = document.getElementById('componente_item_' + i);
            if (compInput != null) {
                if (compInput.value.toLowerCase() == componente) {
                    alert("Esta métrica já foi adicionada à lista.");
                    return;
                }
            }
        }

        var limite;
        if (limitePreenchido != null) {
            limite = limitePreenchido;
        } else {
            limite = document.getElementById('limite_master').value;
        }

        if (limite == "" || isNaN(limite)) {
            alert("Informe um limite válido.");
            return;
        }

        var limiteNumero = Number(limite);
        var indice = indiceParametro;
        var labelLimite = componente == "processos" ? "Contagem de Alerta" : "Limite de Alerta (%)";
        var maxAttr = componente == "processos" ? "" : 'max="100"';

        var bloco = `
            <div class="infos-third item-da-lista" id="parametro_${indice}">
                <div class="drop drop-componente" style="width: 45%;">
                    <h2>Métrica</h2>
                    <input type="text" id="componente_item_${indice}" value="${componente.toUpperCase()}" readonly style="background-color: #eee;">
                </div>
                <div class="drop drop-limite" style="width: 45%;">
                    <h2>${labelLimite}</h2>
                    <input type="number" id="limite_item_${indice}" value="${limiteNumero}" min="1" ${maxAttr}>
                </div>
                <div class="drop drop-lixeira" style="width: 10%; display: flex; align-items: flex-end; justify-content: center;">
                    <i class="bi bi-trash3" onclick="removerParametro(${indice})"></i>
                </div>
            </div>
        `;

        document.getElementById("parametros-container").innerHTML += bloco;
        indiceParametro++;

        if (componentePreenchido == null) {
            document.getElementById('componente_master').value = "";
            document.getElementById('limite_master').value = "";
            document.getElementById('btn_adicionar_parametro').disabled = true;
        }
    }

    function removerParametro(indice) {
        var compInput = document.getElementById('componente_item_' + indice);
        if (compInput == null) return;

        var componente = compInput.value.toLowerCase();
        if (componente == 'cpu' || componente == 'ram' || componente == 'disco') {
            alert("CPU, RAM e Disco são obrigatórios.");
            return;
        }

        var div = document.getElementById('parametro_' + indice);
        if (div != null) div.remove();
    }

    function obterParametrosDaTela() {
        var parametros = [];
        var temCPU = false, temRAM = false, temDisco = false;
        var encontrouAlgum = false;

        for (var i = 0; i <= indiceParametro; i++) {
            var compInput = document.getElementById('componente_item_' + i);
            var limInput = document.getElementById('limite_item_' + i);

            if (compInput != null && limInput != null) {
                encontrouAlgum = true;
                var componente = compInput.value.toLowerCase();
                var limite = limInput.value;

                if (limite == "" || isNaN(limite) || Number(limite) <= 0) {
                    alert("Preencha valores válidos.");
                    return null;
                }

                var limiteMax = componente == 'processos' ? limite : 100;
                parametros.push({ componente: componente, limiteMin: limite, limiteMax: limiteMax });

                if (componente == 'cpu') temCPU = true;
                if (componente == 'ram') temRAM = true;
                if (componente == 'disco') temDisco = true;
            }
        }

        if (!encontrouAlgum) {
            alert("Adicione métricas.");
            return null;
        }
        if (!temCPU || !temRAM || !temDisco) {
            alert("CPU, RAM e Disco são obrigatórios.");
            return null;
        }

        return parametros;
    }

    // --- FUNÇÕES DE REQUISIÇÃO (BACKEND) ---
    function cadastrarModelo() {
        var nomeModelo = document.getElementById('input_nome_modelo').value;
        var descricao = document.getElementById('input_descricao').value;
        var idEmpresa = sessionStorage.getItem("FK_EMPRESA");

        if (idEmpresa == null) {
            alert("Sessão inválida.");
            window.location.href = "login.html";
            return;
        }

        if (nomeModelo == "" || descricao == "") {
            alert("Preencha Nome e Descrição.");
            return;
        }

        var parametros = obterParametrosDaTela();
        if (parametros == null) return;

        fetch("/modelo/cadastrarModelo", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                nomeModeloServer: nomeModelo,
                descricaoServer: descricao,
                parametrosServer: parametros,
                fkEmpresaServer: idEmpresa
            })
        })
        .then(function (resposta) {
            if (resposta.ok) {
                alert("Cadastro realizado!");
                window.location.reload();
            } else {
                resposta.text().then(function (texto) {
                    alert("Erro: " + texto);
                });
            }
        })
        .catch(function () {
            alert("Erro de conexão.");
        });
    }

    function salvarAlteracoes(idModelo) {
        var nomeModelo = document.getElementById('input_nome_modelo').value;
        var descricao = document.getElementById('input_descricao').value;

        if (nomeModelo == "" || descricao == "") {
            alert("Preencha Nome e Descrição.");
            return;
        }

        var parametros = obterParametrosDaTela();
        if (parametros == null) return;

        fetch("/modelo/atualizarModelo", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                idModeloServer: idModelo,
                nomeModeloServer: nomeModelo,
                descricaoServer: descricao,
                parametrosServer: parametros
            })
        })
        .then(function (resposta) {
            if (resposta.ok) {
                alert("Atualizado com sucesso!");
                window.location.reload();
            } else {
                alert("Erro ao atualizar.");
            }
        })
        .catch(function () {
            alert("Erro de conexão.");
        });
    }

    function carregarDadosAprovados() {
        var idEmpresa = sessionStorage.getItem("FK_EMPRESA");

        fetch("/modelo/verificarAprovados", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ idEmpresaServer: idEmpresa })
        })
        .then(function (resposta) {
            if (resposta.ok) {
                resposta.json().then(function (listaModelos) {
                    aprovados = listaModelos;
                    gerarCardModelos();
                });
            } else {
                aprovados = [];
                gerarCardModelos();
            }
        })
        .catch(function () {
            aprovados = [];
            gerarCardModelos();
        });
    }

    function gerarCardModelos() {
        var div = document.getElementById('div_aprovados');
        div.innerHTML = "";
        
        for (var i = 0; i < aprovados.length; i++) {
            var modelo = aprovados[i];
            
            div.innerHTML += `
                <div class="card-user" onclick="abrirPopupParaEditar(${modelo.idModelo})">
                    <div class="card-first">
                        <div class="labels">
                            <label id="first">Nome:</label>
                            <label class="label-item">${modelo.nome}</label>
                        </div>
                        <div class="labels">
                            <label id="first">Descrição:</label>
                            <label class="label-item">${modelo.descricao_arq}</label>
                        </div>
                    </div>
                    <div class="card-second" style="justify-content: flex-end;">
                        <i class="bi bi-trash3 icon-deletar" 
                           onclick="event.stopPropagation(); deletarModelo(${modelo.idModelo})">
                        </i>
                    </div>
                </div>
            `;
        }
    }

    function deletarModelo(idModelo) {
        if (!confirm("Tem certeza que deseja excluir este modelo?")) {
            return;
        }

        fetch("/modelo/deletarModelo", {
            method: "DELETE",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ idModeloServer: idModelo })
        })
        .then(function (resposta) {
            if (resposta.ok) {
                alert("Modelo deletado com sucesso!");
                window.location.reload();
            } else {
                resposta.json().then(function (json) {
                    alert("Erro ao deletar: " + json);
                });
            }
        })
        .catch(function (erro) {
            console.log(erro);
        });
    }

    function abrirPopupParaEditar(idModelo) {
        if (idModelo == null) return;

        document.getElementById('parametros-container').innerHTML = "";
        indiceParametro = 0;
        document.getElementById('popup_titulo').innerText = "Editar Modelo";
        var botaoPopup = document.getElementById('popup_button');
        botaoPopup.innerText = "Salvar Alterações";
        botaoPopup.onclick = function () { salvarAlteracoes(idModelo); };

        var idEmpresa = sessionStorage.getItem("FK_EMPRESA");

        function preencherModeloNaTela(dadosModelo) {
            document.getElementById('input_nome_modelo').value = dadosModelo.info.nome;
            document.getElementById('input_descricao').value = dadosModelo.info.descricao_arq;
            indiceParametro = 0;
            for (var indice = 0; indice < dadosModelo.parametros.length; indice++) {
                var p = dadosModelo.parametros[indice];
                adicionarParametro(p.nome, p.limiteMin);
            }
            abrirPopupTela();
        }

        fetch("/modelo/buscarDefaults", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ fkEmpresaServer: idEmpresa })
        })
        .then(function (respostaDefaults) {
            if (respostaDefaults.ok) {
                respostaDefaults.json().then(function (listaDefaults) {
                    valoresDefault = listaDefaults;
                    carregarSelectMetricas();
                    
                    fetch("/modelo/buscarModeloPorId?id=" + idModelo, { method: "GET" })
                    .then(function (respostaModelo) {
                        if (respostaModelo.ok) {
                            respostaModelo.json().then(function (dadosModelo) {
                                preencherModeloNaTela(dadosModelo);
                            });
                        } else {
                            alert("Erro ao carregar modelo.");
                        }
                    });
                });
            }
        });
    }
</script>

</html>