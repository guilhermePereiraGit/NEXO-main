<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Página de Aprovação NEXO</title>
    <link rel="shortcut icon" href="assets/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="dashboard/gestor/silva/modelos.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="./css/gestor_unificado.css">
</head>

<body onload="carregarDadosAprovados()">

    <div class="container">
        <header>
            <div class="header-container">
                <div class="header-menu">
                    <div class="menu" id="menu" onclick="abrirMenu()">
                        <i class="bi bi-list" id="icone"></i>
                    </div>
                </div>

                <div class="header-navigation">
                    <div class="home">
                        <div class="fundo" style="display: block;"></div>
                        <i class="bi bi-house" onclick="window.location.href = 'dashboard/gestor/silva/modelos.html'"
                            style="color: #451c8b;"></i>
                    </div>
                    <div class="eficiencia">
                        <div class="fundo" id="fundo2" style="display: none;"></div>
                        <i class="bi bi-clipboard-data"
                            onclick="window.location.href = 'dashboard/gestor/gabriel/eficiencia.html'" id="second"></i>
                    </div>
                    <div class="modelos">
                        <div class="fundo" id="fundo2" style="display: none;"></div>
                        <i class="bi bi-clipboard-data" onclick="window.location.href = 'gestor.html'" id="hi"></i>
                    </div>
                    <div class="sair">
                        <div class="fundo" style="display: none;"></div>
                        <i class="bi bi-box-arrow-left" onclick="ativarPopup()"></i>
                    </div>
                </div>

                <div class="header-help">
                    <i class="bi bi-info-circle" onclick="abrirPassos()"></i>
                </div>
            </div>
            <div class="menu-extend" style="display: none;" id="extend">
                <div class="infos-user">
                    <h1 id="nome_user"></h1>
                    <h2>Gestor de Operações</h2>
                </div>
                <div class="widgets">
                    <p>Caso se depare com algum problema, entre em contato via:</p>
                    <div class="email" style="margin-top: 20px;">
                        <i class="bi bi-envelope"></i>
                        <p>Email: nexoadm9328@outlook.com</p>
                    </div>
                    <div class="telefone" style="margin-top: 20px;">
                        <i class="bi bi-telephone"></i>
                        <p>Telefone: +55(11)98802-2449</p>
                    </div>
                </div>
                <div class="jira-slack">
                    <div class="card"
                        onclick="window.location.href = 'https://nexoadm.atlassian.net/jira/servicedesk/projects/NEXO/summary?ignoreStickyVersion=true'">
                        <img src="../../../assets/imgs/icon-jira.png">
                        <h1>Jira</h1>
                    </div>
                    <div class="card"
                        onclick="window.location.href = 'https://app.slack.com/client/T09LFRM7PFX/C09LH8XJS22'">
                        <img src="../../../assets/imgs/icon-slack.png">
                        <h1>Slack</h1>
                    </div>
                </div>
            </div>
        </header>
        <div class="main">
            <div class="topo">
                <h2 style="margin-left: 70px;">Modelos Cadastrados</h2>
                <button onclick="abrirPopupModelo()" style="margin-right: 70px;">Adicionar Modelo</button>
            </div>
            <div class="baixo">
                <div class="conteudo">
                    <div class="div_aprovados" id="div_aprovados">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="popup-cadastro" id="popupmodelo" style="display: none;">
        <div class="cadastro-content" style="height: auto; max-height: 85vh;">

            <i class="bi bi-x-lg" onclick="fecharPopupModelo()"></i>
            <h1 id="popup_titulo" style="text-align: center; margin-bottom: 20px;">Cadastro de Modelo</h1>

            <div class="infos" style="flex-grow: 1; overflow-y: auto;">

                <div class="infos-first">
                    <div class="drop">
                        <h2>Nome</h2>
                        <input type="text" id="input_nome_modelo">
                    </div>
                    <div class="drop">
                        <h2>Descrição</h2>
                        <input type="text" id="input_descricao">
                    </div>
                </div>

                <h1 style="margin-top: 20px;">Métricas de Monitoramento:</h1>

                <p class="info-default">
                    Ao selecionar uma métrica e clicar em <strong><u>Adicionar Parâmetro</u></strong>, um valor padrão
                    será sugerido.
                    Para CPU, RAM e Disco, este é o <strong><u>percentual máximo de uso</u></strong>.
                    Para Processos, é a <strong><u>contagem total</u></strong>.
                    Sinta-se à vontade para ajustar estes valores.
                </p>

                <div class="infos-third" id="linha-input-estatica">
                    <div class="drop" style="width: 60%;">

                        <select id="componente_master" class="componentes" onchange="definirDefault(this)">
                            <option value="">Selecione para adicionar...</option>
                        </select>

                        <input type="hidden" id="limite_master">
                    </div>
                    <div class="drop" style="width: 40%;">
                        <button class="cadastrar" id="btn_adicionar_parametro" onclick="adicionarParametro()"
                            style="background-color: var(--fundo); color: var(--principal); border: 1px solid var(--principal);"
                            disabled>Adicionar Parâmetro</button>
                    </div>
                </div>

                <div class="parametros-scroll" id="parametros-container"
                    style="padding-right: 15px; margin-top: 10px; border-top: 1px solid #e9ecef; padding-top: 10px;">
                </div>

            </div>
            <div class="infos-final">
                <div class="drop" style="width: 100%;">
                    <button class="cadastrar" id="popup_button" onclick="cadastrarModelo()">Cadastrar Modelo</button>
                </div>
            </div>

        </div>
    </div>
</body>

<script>
    var valoresDefault = [];
    var aprovados = [];
    var indiceParametro = 0;

    function abrirPopupModelo() {
        document.getElementById('input_nome_modelo').value = "";
        document.getElementById('input_descricao').value = "";
        document.getElementById('btn_adicionar_parametro').disabled = true;
        document.getElementById('parametros-container').innerHTML = "";
        indiceParametro = 0;

        document.getElementById('popup_titulo').innerText = "Cadastro de Modelo";
        var btn = document.getElementById('popup_button');
        btn.innerText = "Cadastrar Modelo";
        btn.onclick = cadastrarModelo;

        var idEmpresa = sessionStorage.getItem("ID_EMPRESA");

        fetch("/modelo/buscarDefaults", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ fkEmpresaServer: idEmpresa })
        })
            .then(function (resposta) {
                if (resposta.ok) {
                    resposta.json().then(function (data) {
                        valoresDefault = data;
                        carregarSelectMetricas();
                        var popup = $("#popupmodelo");
                        popup.css({ display: "flex", opacity: 0, "pointer-events": "auto" }).animate({ opacity: 1 }, 300);
                    });
                } else {
                    valoresDefault = [
                        { "componente": "cpu", "valor": 60 },
                        { "componente": "ram", "valor": 70 },
                        { "componente": "disco", "valor": 50 },
                        { "componente": "processos", "valor": 500 }
                    ];
                    carregarSelectMetricas();
                    var popup2 = $("#popupmodelo");
                    popup2.css({ display: "flex", opacity: 0, "pointer-events": "auto" }).animate({ opacity: 1 }, 300);
                }
            })
            .catch(function () {
                valoresDefault = [
                    { "componente": "cpu", "valor": 60 },
                    { "componente": "ram", "valor": 70 },
                    { "componente": "disco", "valor": 50 },
                    { "componente": "processos", "valor": 500 }
                ];
                carregarSelectMetricas();
                var popup3 = $("#popupmodelo");
                popup3.css({ display: "flex", opacity: 0, "pointer-events": "auto" }).animate({ opacity: 1 }, 300);
            });
    }

    function fecharPopupModelo() {
        var popup = $("#popupmodelo");
        popup.css({ display: "flex", opacity: 1, "pointer-events": "none" }).animate({ opacity: 0 }, 300);
        setTimeout(function () {
            window.location.reload();
        }, 1000);
    }

    function definirDefault(selectElement) {
        var valorSelecionado = selectElement.value.toLowerCase();
        var limiteInput = document.getElementById('limite_master');
        var btnAdicionar = document.getElementById('btn_adicionar_parametro');

        if (valorSelecionado == "") {
            btnAdicionar.disabled = true;
            limiteInput.value = "";
            return;
        }

        var j = 0;
        var encontrou = false;
        for (j = 0; j < valoresDefault.length; j++) {
            if (valoresDefault[j].componente == valorSelecionado) {
                limiteInput.value = valoresDefault[j].valor;
                encontrou = true;
            }
        }

        if (encontrou == false) {
            limiteInput.value = "";
        }

        btnAdicionar.disabled = false;
    }

    function carregarSelectMetricas() {
        var select = document.getElementById('componente_master');

        var opcoes = '<option value="">Selecione para adicionar...</option>';

        if (valoresDefault.length == 0) {
            select.innerHTML = opcoes;
            return;
        }

        var i = 0;
        for (i = 0; i < valoresDefault.length; i++) {
            var item = valoresDefault[i];
            var componenteLower = item.componente.toLowerCase();
            var componenteUpper = item.componente.toUpperCase();

            opcoes += '<option value="' + componenteLower + '">' +
                componenteUpper +
                '</option>';
        }

        select.innerHTML = opcoes;
    }

    function adicionarParametro(componentePreenchido, limitePreenchido) {
        var componente;

        if (componentePreenchido != null) {
            componente = componentePreenchido;
        } else {
            componente = document.getElementById('componente_master').value;
        }

        if (componente == "") {
            alert("Selecione uma métrica antes de adicionar.");
            return;
        }

        componente = componente.toLowerCase();

        var i = 0;
        for (i = 0; i <= indiceParametro; i++) {
            var compInput = document.getElementById('componente_item_' + i);
            if (compInput != null) {
                var valorComp = compInput.value.toLowerCase();
                if (valorComp == componente) {
                    alert("Esta métrica já foi adicionada à lista.");
                    return;
                }
            }
        }

        var limite;
        if (limitePreenchido != null) {
            limite = limitePreenchido;
        } else {
            limite = document.getElementById('limite_master').value;
        }

        if (limite == "" || isNaN(limite)) {
            alert("Informe um limite válido para a métrica.");
            return;
        }

        var limiteNumero = Number(limite);
        var indice = indiceParametro;

        var bloco = "";

        if (componente == "processos") {
            bloco = `
                <div class="infos-third item-da-lista" id="parametro_${indice}">
                    <div class="drop drop-componente">
                        <h2>Métrica</h2>
                        <input type="text" id="componente_item_${indice}" value="${componente.toUpperCase()}" readonly>
                    </div>
                    <div class="drop drop-limite">
                        <h2>Contagem de Alerta</h2>
                        <input type="number" id="limite_item_${indice}" value="${limiteNumero}" min="1">
                    </div>
                    <div class="drop drop-lixeira">
                        <i class="bi bi-trash3" onclick="removerParametro(${indice})"></i>
                    </div>
                </div>
            `;
        } else {
            bloco = `
                <div class="infos-third item-da-lista" id="parametro_${indice}">
                    <div class="drop drop-componente">
                        <h2>Métrica</h2>
                        <input type="text" id="componente_item_${indice}" value="${componente.toUpperCase()}" readonly>
                    </div>
                    <div class="drop drop-limite">
                        <h2>Limite de Alerta (%)</h2>
                        <input type="number" id="limite_item_${indice}" value="${limiteNumero}" min="1" max="100">
                    </div>
                    <div class="drop drop-lixeira">
                        <i class="bi bi-trash3" onclick="removerParametro(${indice})"></i>
                    </div>
                </div>
            `;
        }

        var container = document.getElementById("parametros-container");
        container.innerHTML += bloco;

        indiceParametro = indiceParametro + 1;

        if (componentePreenchido == null) {
            document.getElementById('componente_master').value = "";
            document.getElementById('limite_master').value = "";
            document.getElementById('btn_adicionar_parametro').disabled = true;
        }
    }

    function removerParametro(indice) {
        var compInput = document.getElementById('componente_item_' + indice);
        if (compInput == null) {
            return;
        }

        var componente = compInput.value.toLowerCase();

        if (componente == 'cpu' || componente == 'ram' || componente == 'disco') {
            alert("CPU, RAM e Disco são métricas obrigatórias e não podem ser removidas.");
            return;
        }

        var div = document.getElementById('parametro_' + indice);
        if (div != null) {
            div.remove();
        }
    }

    function obterParametrosDaTela() {
        var parametros = [];
        var temCPU = false;
        var temRAM = false;
        var temDisco = false;
        var encontrouAlgum = false;

        var i = 0;
        for (i = 0; i <= indiceParametro; i++) {
            var compInput = document.getElementById('componente_item_' + i);
            var limInput = document.getElementById('limite_item_' + i);

            if (compInput != null && limInput != null) {
                encontrouAlgum = true;

                var componente = compInput.value.toLowerCase();
                var limite = limInput.value;

                if (limite == "" || isNaN(limite) || Number(limite) <= 0) {
                    alert("Preencha valores válidos para todas as métricas.");
                    return null;
                }

                var limiteMin = limite;
                var limiteMax = 100;

                if (componente == 'processos') {
                    limiteMax = limite;
                }

                parametros.push({
                    componente: componente,
                    limiteMin: limiteMin,
                    limiteMax: limiteMax
                });

                if (componente == 'cpu') {
                    temCPU = true;
                }
                if (componente == 'ram') {
                    temRAM = true;
                }
                if (componente == 'disco') {
                    temDisco = true;
                }
            }
        }

        if (encontrouAlgum == false) {
            alert("Adicione pelo menos uma métrica ao modelo.");
            return null;
        }

        if (temCPU == false || temRAM == false || temDisco == false) {
            alert("É obrigatório adicionar CPU, RAM e Disco ao modelo.");
            return null;
        }

        return parametros;
    }

    function cadastrarModelo() {
        var nomeModelo = document.getElementById('input_nome_modelo').value;
        var descricao = document.getElementById('input_descricao').value;
        var idEmpresa = sessionStorage.getItem("ID_EMPRESA");

        if (nomeModelo == "" || descricao == "") {
            alert("Por favor, preencha os campos Nome e Descrição.");
            return;
        }

        var parametros = obterParametrosDaTela();
        if (parametros == null) {
            return;
        }

        fetch("/modelo/cadastrarModelo", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                nomeModeloServer: nomeModelo,
                descricaoServer: descricao,
                parametrosServer: parametros,
                fkEmpresaServer: idEmpresa
            })
        })
            .then(function (resposta) {
                if (resposta.ok) {
                    alert("Cadastro realizado com sucesso!");
                    setTimeout(function () {
                        window.location.reload();
                    }, 1500);
                } else {
                    alert("Erro ao cadastrar modelo.");
                }
            })
            .catch(function () {
                alert("Erro de conexão. Verifique sua rede e tente novamente.");
            });
    }

    function salvarAlteracoes(idModelo) {
        var nomeModelo = document.getElementById('input_nome_modelo').value;
        var descricao = document.getElementById('input_descricao').value;

        if (nomeModelo == "" || descricao == "") {
            alert("Por favor, preencha os campos Nome e Descrição.");
            return;
        }

        var parametros = obterParametrosDaTela();
        if (parametros == null) {
            return;
        }

        fetch("/modelo/atualizarModelo", {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                idModeloServer: idModelo,
                nomeModeloServer: nomeModelo,
                descricaoServer: descricao,
                parametrosServer: parametros
            })
        })
            .then(function (resposta) {
                if (resposta.ok) {
                    alert("Modelo atualizado com sucesso!");
                    setTimeout(function () {
                        window.location.reload();
                    }, 1500);
                } else {
                    alert("Erro ao atualizar modelo. Tente novamente.");
                }
            })
            .catch(function () {
                alert("Erro de conexão. Verifique sua rede e tente novamente.");
            });
    }

    function carregarDadosAprovados() {
        var idEmpresa = sessionStorage.getItem("ID_EMPRESA");

        fetch("/modelo/verificarAprovados", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ idEmpresaServer: idEmpresa })
        }).then(function (resposta) {
            if (resposta.ok) {
                resposta.json().then(function (data) {
                    aprovados = data;
                    if (aprovados.length > 0) {
                        gerarCardModelos();
                    } else {
                        nadaPorAquiModelos();
                    }
                });
            } else {
                nadaPorAquiModelos();
            }
        });
    }

    function nadaPorAquiModelos() {
        var div = document.getElementById('div_aprovados');
        div.innerHTML = `
            <div class="card-nothing">
                <h1>Sem Registros</h1>
                <p>Caso isto não seja o esperado pelo nosso sistema, considere entrar em contato com nossa equipe de suporte</p>
                <p>Estamos à sua disposição para solucionar seus incidentes e tornar sua experiência verdadeiramente NEXO.</p>
            </div>
        `;
    }

    function gerarCardModelos() {
        var div = document.getElementById('div_aprovados');
        div.innerHTML = "";
        var i = 0;
        for (i = 0; i < aprovados.length; i++) {
            var modelo = aprovados[i];
            var idDoModelo = modelo.idModelo;

            div.innerHTML += `
                <div class="card-user" onclick="abrirPopupParaEditar(${idDoModelo})">
                    <div class="card-first">
                        <div class="labels"><label id="first">Nome:</label><label class="label-item">${modelo.nome}</label></div>
                        <div class="labels"><label id="first">Descrição:</label><label class="label-item">${modelo.descricao_arq}</label></div>
                    </div>
                    <div class="card-second">
                        <div class="labels"><label id="first">Status:</label><label class="label-item">${modelo.status}</label></div>
                    </div>
                </div>
            `;
        }
    }

    function abrirPopupParaEditar(idModelo) {
        if (idModelo == null) {
            return;
        }

        document.getElementById('parametros-container').innerHTML = "";
        indiceParametro = 0;

        document.getElementById('popup_titulo').innerText = "Editar Modelo";
        var btn = document.getElementById('popup_button');
        btn.innerText = "Salvar Alterações";
        btn.onclick = function () {
            salvarAlteracoes(idModelo);
        };

        var idEmpresa = sessionStorage.getItem("ID_EMPRESA");

        fetch("/modelo/buscarDefaults", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ fkEmpresaServer: idEmpresa })
        })
            .then(function (resposta) {
                if (resposta.ok) {
                    resposta.json().then(function (data) {
                        valoresDefault = data;
                        carregarSelectMetricas();

                        fetch("/modelo/buscarModeloPorId?id=" + idModelo, { method: "GET" })
                            .then(function (res) {
                                if (!res.ok) {
                                    alert("Não foi possível carregar os dados deste modelo.");
                                } else {
                                    res.json().then(function (dadosDoModelo) {

                                        document.getElementById('input_nome_modelo').value = dadosDoModelo.info.nome;
                                        document.getElementById('input_descricao').value = dadosDoModelo.info.descricao_arq;

                                        indiceParametro = 0;
                                        var i = 0;
                                        for (i = 0; i < dadosDoModelo.parametros.length; i++) {
                                            var param = dadosDoModelo.parametros[i];
                                            adicionarParametro(param.nome, param.limiteMin);
                                        }

                                        var popup = $("#popupmodelo");
                                        popup.css({ display: "flex", opacity: 0, "pointer-events": "auto" }).animate({ opacity: 1 }, 300);
                                    });
                                }
                            })
                            .catch(function () {
                                alert("Não foi possível carregar os dados deste modelo.");
                            });
                    });
                } else {
                    valoresDefault = [
                        { "componente": "cpu", "valor": 60 },
                        { "componente": "ram", "valor": 70 },
                        { "componente": "disco", "valor": 50 },
                        { "componente": "processos", "valor": 500 }
                    ];
                    carregarSelectMetricas();

                    fetch("/modelo/buscarModeloPorId?id=" + idModelo, { method: "GET" })
                        .then(function (res2) {
                            if (!res2.ok) {
                                alert("Não foi possível carregar os dados deste modelo.");
                            } else {
                                res2.json().then(function (dadosDoModelo2) {

                                    document.getElementById('input_nome_modelo').value = dadosDoModelo2.info.nome;
                                    document.getElementById('input_descricao').value = dadosDoModelo2.info.descricao_arq;

                                    indiceParametro = 0;
                                    var i2 = 0;
                                    for (i2 = 0; i2 < dadosDoModelo2.parametros.length; i2++) {
                                        var param2 = dadosDoModelo2.parametros[i2];
                                        adicionarParametro(param2.nome, param2.limiteMin);
                                    }

                                    var popup2 = $("#popupmodelo");
                                    popup2.css({ display: "flex", opacity: 0, "pointer-events": "auto" }).animate({ opacity: 1 }, 300);
                                });
                            }
                        })
                        .catch(function () {
                            alert("Não foi possível carregar os dados deste modelo.");
                        });
                }
            })
            .catch(function () {
                valoresDefault = [
                    { "componente": "cpu", "valor": 60 },
                    { "componente": "ram", "valor": 70 },
                    { "componente": "disco", "valor": 50 },
                    { "componente": "processos", "valor": 500 }
                ];
                carregarSelectMetricas();

                fetch("/modelo/buscarModeloPorId?id=" + idModelo, { method: "GET" })
                    .then(function (res3) {
                        if (!res3.ok) {
                            alert("Não foi possível carregar os dados deste modelo.");
                        } else {
                            res3.json().then(function (dadosDoModelo3) {

                                document.getElementById('input_nome_modelo').value = dadosDoModelo3.info.nome;
                                document.getElementById('input_descricao').value = dadosDoModelo3.info.descricao_arq;

                                indiceParametro = 0;
                                var i3 = 0;
                                for (i3 = 0; i3 < dadosDoModelo3.parametros.length; i3++) {
                                    var param3 = dadosDoModelo3.parametros[i3];
                                    adicionarParametro(param3.nome, param3.limiteMin);
                                }

                                var popup3 = $("#popupmodelo");
                                popup3.css({ display: "flex", opacity: 0, "pointer-events": "auto" }).animate({ opacity: 1 }, 300);
                            });
                        }
                    })
                    .catch(function () {
                        alert("Não foi possível carregar os dados deste modelo.");
                    });
            });
    }
</script>

</html>