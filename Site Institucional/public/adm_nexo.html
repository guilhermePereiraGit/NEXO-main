<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADM - NEXO</title>
    <link rel="stylesheet" href="./css/adm_nexo.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body onload="carregarDados(),carregarDadosAprovados()">
    <div class="tudo">
        <header>
            <div class="header-container">
                <!-- MENU -->
                <div class="header-menu">
                    <div class="menu" id="menu" onclick="abrirMenu()">
                        <i class="bi bi-list" id="icone"></i>
                    </div>
                </div>

                <!-- NAVEGAÇÃO -->
                <div class="header-navigation">
                    <div class="pendent">
                        <div class="fundo" id="fundo3" style="display: none;"></div>
                        <i class="bi bi-buildings"><a href="#div_aprovados"></a></i>
                    </div>
                    <div class="alert">
                        <div class="fundo" id="fundo3" style="display: none;"></div>
                        <i class="bi bi-clock-history"><a href="#div_pendentes"></a></i>
                    </div>
                    <div class="sair">
                        <div class="fundo" style="display: none;"></div>
                        <i class="bi bi-box-arrow-left" onclick="ativarPopup()"></i>
                    </div>
                </div>
            </div>
            <div class="menu-extend" style="display: none;" id="extend">
                <div class="infos-user">
                    <h1 id="lbl_nome">Guilherme Silva</h1>
                    <h2 style="align-self: center;">Administrador</h2>
                </div>
                <div class="widgets">
                    <p>Caso se depare com algum problema, entre em contato via:</p>
                    <div class="email" style="margin-top: 20px;">
                        <i class="bi bi-envelope"></i>
                        <p id="lbl_email"></p>
                    </div>
                    <div class="telefone" style="margin-top: 20px;">
                        <i class="bi bi-telephone"></i>
                        <p>Telefone: +55(11)98802-2449</p>
                    </div>
                </div>
                <div class="jira-slack">
                    <div class="card"
                        onclick="window.location.href = 'https://nexoadm.atlassian.net/jira/servicedesk/projects/NEXO/summary?ignoreStickyVersion=true'">
                        <img src="./assets/imgs/icon-jira.png">
                        <h1>Jira</h1>
                    </div>
                    <div class="card"
                        onclick="window.location.href = 'https://app.slack.com/client/T09LFRM7PFX/C09LH8XJS22'">
                        <img src="./assets/imgs/icon-slack.png">
                        <h1>Slack</h1>
                    </div>
                </div>
            </div>
        </header>

        <!-- POPUP DE LOGOUT -->
        <div class="popup-logout" style="display: none;" id="popup-logout">
            <div class="popup-content">
                <i class="bi bi-x-lg" onclick="fecharPopup()"></i>
                <h1>Deseja Sair?</h1>
                <div class="box-button">
                    <button>Fazer Logout</button>
                </div>
            </div>
        </div>
        <div class="main">
            <div class="topo">
                <h2 style="margin-left: 70px;">Empresas no sistema</h2>
            </div>
            <div class="baixo">
                <div class="conteudo">
                    <div class="aprovados" id="div_aprovados">
                    </div>
                </div>
            </div>
            <div class="baixo">
                <div class="conteudo">
                    <div class="pendentes" id="div_pendentes">
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

<script>
aprovados = [];
    //Funções de Nada por Aqui
    function nadaPorAquiAprovados() {
        div_aprovados.innerHTML = `
        <div class="card-nothing">
                <h1>Sem Registros Aprovados</h1>
                <p>Caso isto não seja o esperado pelo nosso sistema, considere entrar em contato com nossa equipe de suporte</p>
                <p>Estamos à sua disposição para solucionar seus incidentes e tornar sua experiência verdadeiramente NEXO.</p>
            </div>
        `;
    }

    function nadaPorAquiPendentes() {
        div_pendentes.innerHTML = `
            <div class="card-nothing">
                <h1>Sem Registros para Aprovação</h1>
                <p>Caso isto não seja o esperado pelo nosso sistema, considere entrar em contato com nossa equipe de suporte</p>
                <p>Estamos à sua disposição para solucionar seus incidentes e tornar sua experiência verdadeiramente NEXO.</p>
            </div>
        `;
    }

    empresas = [];
    function carregarDados() {
        nome = sessionStorage.getItem("NOME_USUARIO");
        email = sessionStorage.getItem("EMAIL_USUARIO")
        lbl_nome.innerHTML = nome;
        lbl_email.innerHTML = email;

        fetch("/aprovacao/verificar", {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            },
        }).then(function (resposta) {
            console.log(resposta);

            if (resposta.ok) {
                resposta.json().then(data => {
                    console.log(data);
                    empresas = data;
                    if (empresas.length > 0) {
                        gerarCards();
                    } else {
                        nadaPorAquiPendentes();
                    }
                })
            } else {
                console.log("Erro ao Buscar Dados!");
            }
        });
    }

    function gerarCards() {
        for (var i = 0; i < empresas.length; i++) {
            div_pendentes.innerHTML += `
            <div class = "card-user">
                <div class = "card-first">
                    <div class="labels"><label id="first">Nome:</label><label class="label-item">${empresas[i].nome}</label></div>
                    <div class="labels"><label id="first">CNPJ:</label><label class="label-item">${empresas[i].cnpj}</label></div>
                </div>
                <div class = "card-second">
                    <div class="labels"><label id="first">Email:</label><label class="label-item">${empresas[i].email}</label></div>
                    <div class="labels"><label id="first">Telefone:</label><label class="label-item">${empresas[i].telefone}</label></div>
                </div>
                <div class = "card-second">
                    <div class = "buttons">
                        <button class = "aprovar" onclick = "aprovar(${empresas[i].idEmpresa})">Aprovar</button>
                        <button class = "reprovar" onclick = "recusar(${empresas[i].idEmpresa})">Reprovar</button>    
                    </div>
                </div>
            </div>
            `;
        }
    }

    aprovados = [];
    function carregarDadosAprovados() {
        nome = sessionStorage.getItem("NOME_USUARIO");
        email = sessionStorage.getItem("EMAIL_USUARIO")
        lbl_nome.innerHTML = nome;
        lbl_email.innerHTML = email;

        fetch("/aprovacao/verificarAprovados", {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            },
        }).then(function (resposta) {
            console.log(resposta);

            if (resposta.ok) {
                resposta.json().then(data => {
                    console.log(data);
                    aprovados = data;
                    if (aprovados.length > 0) {
                        gerarCardsAprovados();
                    } else {
                        nadaPorAquiAprovados();
                    }
                })
            } else {
                console.log("Erro ao Buscar Dados!");
            }
        });
    }

    function gerarCardsAprovados() {
        for (var i = 0; i < aprovados.length; i++) {
            div_aprovados.innerHTML += `
            <div class = "card-user" onclick="carregarModelos(${aprovados[i].idEmpresa})">
                <div class = "card-first">
                    <div class="labels"><label id="first">Nome:</label><label class="label-item">${aprovados[i].nome}</label></div>
                    <div class="labels"><label id="first">CNPJ:</label><label class="label-item">${aprovados[i].cnpj}</label></div>
                </div>
                <div class = "card-second">
                    <div class="labels"><label id="first">Email:</label><label class="label-item">${aprovados[i].email}</label></div>
                    <div class="labels"><label id="first">Telefone:</label><label class="label-item">${aprovados[i].telefone}</label></div>
                </div>
                <div class = "card-second">
                    <div class = "buttons">
                        <button class="reprovar" onclick="event.stopPropagation(); limparFuncionarios(${aprovados[i].idEmpresa})">Cancelar</button>    
                    </div>
                </div>
            </div>
            `;
        }
    }

    function aprovar(idEmpresa) {
        var idEmpresaVar = idEmpresa;

        fetch("/aprovacao/aprovar", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({ idEmpresaServer: idEmpresaVar }),
        })
            .then(function (resposta) {
                console.log("resposta: ", resposta);

                if (resposta.ok) {
                    window.location.reload();
                } else {
                    resposta.innerHTML = "Erro ao Aprovar"
                }
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
        return false;
    }

    function limparFuncionarios(idEmpresa) {
        var idEmpresaVar = idEmpresa;

        fetch("/usuarios/limparFuncionarios", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({ fkEmpresa: idEmpresaVar }),
        })
            .then(function (resposta) {
                console.log("resposta: ", resposta);

                if (resposta.ok) {
                    removerEmpresa(idEmpresaVar);
                } else {
                    resposta.innerHTML = "Erro ao Aprovar"
                }
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
        return false;
    }

    function removerEmpresa(idEmpresa) {
        var idEmpresaVar = idEmpresa;

        fetch("/usuarios/deletarEmpresa", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({ idEmpresa: idEmpresaVar }),
        })
            .then(function (resposta) {
                console.log("resposta: ", resposta);

                if (resposta.ok) {
                    window.location.reload()
                } else {
                    resposta.innerHTML = "Erro ao Aprovar"
                }
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
        return false;
    }

    function recusar(idEmpresa) {
        var idEmpresaVar = idEmpresa;

        fetch("/aprovacao/recusar", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({ idEmpresaServer: idEmpresaVar }),
        })
            .then(function (resposta) {
                console.log("resposta: ", resposta);

                if (resposta.ok) {
                    window.location.reload();
                } else {
                    console.error("Erro ao Recusar")
                }
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
        return false;
    }

    function carregarModelos(idEmpresa) {
        window.location.href = `modelos.html?id=${idEmpresa}`;
    }

    function abrirMenu() {
        menu_icon = document.getElementById('icone');
        menu = document.querySelector('.menu-extend');
        if (menu_icon.classList.contains("bi-list")) {
            console.log("entrei");
            document.getElementById('extend').style.display = "flex";
            menu.style.animation = "expandirDireita 0.5s ease forwards";
            menu_icon.classList.remove("bi-list");
            menu_icon.classList.add("bi-x-lg")

        } else {
            menu.style.animation = "recolherEsquerda 0.5s ease forwards";
            menu_icon.classList.remove("bi-x-lg");
            menu_icon.classList.add("bi-list")
        }
    }

    function ativarPopup() {
        popup = $("#popup-logout");
        popup.css({ display: "flex", opacity: 0, "pointer-events": "auto" }).animate({ opacity: 1 }, 300);
    }
    function fecharPopup() {
        popup = $("#popup-logout");
        popup.css({ display: "flex", opacity: 0, "pointer-events": "none" }).animate({ opacity: 0 }, 300);
    }

    function abrirEscolha() {
        popup = $("#popup-escolha");
        popup.css({ display: "flex", opacity: 0, "pointer-events": "auto" }).animate({ opacity: 1 }, 300);
    }
    function fecharEscolha() {
        popup = $("#popup-escolha");
        popup.css({ display: "flex", opacity: 0, "pointer-events": "none" }).animate({ opacity: 0 }, 300);
    }
    function abrirPassos() {
        popup = $("#popup-passos");
        popup.css({ display: "flex", opacity: 0, "pointer-events": "auto" }).animate({ opacity: 1 }, 300);
    }
    function fecharPassos() {
        popup = $("#popup-passos");
        popup.css({ display: "flex", opacity: 0, "pointer-events": "none" }).animate({ opacity: 0 }, 300);
    }
</script>