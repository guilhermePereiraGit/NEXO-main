<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda diária - NEXO</title>
    <link rel="stylesheet" href="../../css/tecnico-novo.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body onload="visualizarChamadosJira()">
    <div class="tudo">
        <header>
            <div class="header-container">
                <!-- MENU -->
                <div class="header-menu">
                    <div class="menu" id="menu" onclick="abrirMenu()">
                        <i class="bi bi-list" id="icone"></i>
                    </div>
                </div>

                <!-- NAVEGAÇÃO -->
                <div class="header-navigation">
                    <div class="icones">
                        <div class="cadastrar-totens">
                            <div class="fundo" id="fundo2" style="display: none;"></div>
                            <i class="bi bi-display" onclick="window.location.href='novo-tecnico.html'"></i>
                        </div>
                        <div class="dashboard">
                            <div class="fundo" id="fundo3" style="display: none;"></div>
                            <i class="bi bi-graph-up" onclick="window.location.href='./matheus/totens.html'"></i>
                        </div>
                        <div class="dashboard-agenda">
                            <div class="fundo" id="fundo4" style="display: block;"></div>
                            <i class="bi bi-calendar3" onclick="ativar('fundo4')" id="fourth" style="color: #451c8b;"></i>
                        </div>
                    </div>
                    <div class="sair">
                        <div class="fundo" style="display: none;"></div>
                        <i class="bi bi-box-arrow-left" onclick="ativarPopup()"></i>
                    </div>
                </div>
            </div>
            <div class="menu-extend" style="display: none;" id="extend">
                <div class="infos-user">
                    <h1>Guilherme Barros</h1>
                    <h2>Técnico de Operações</h2>
                </div>
                <div class="widgets">
                    <p>Caso se depare com algum problema, entre em contato via:</p>
                    <div class="email" style="margin-top: 20px;">
                        <i class="bi bi-envelope"></i>
                        <p>nexo.sptech@gmail.com</p>
                    </div>
                    <div class="telefone" style="margin-top: 20px;">
                        <i class="bi bi-telephone"></i>
                        <p>Telefone: +55(11)98802-2449</p>
                    </div>
                </div>
                <div class="jira-slack">
                    <div class="card-jira-slack"
                        onclick="window.location.href = 'https://nexoadm.atlassian.net/jira/servicedesk/projects/NEXO/summary?ignoreStickyVersion=true'">
                        <img src="../../assets/imgs/icon-jira.png">
                        <h1>Jira</h1>
                    </div>
                    <div class="card-jira-slack"
                        onclick="window.location.href = 'https://app.slack.com/client/T09LFRM7PFX/C09LH8XJS22'">
                        <img src="../../assets/imgs/icon-slack.png">
                        <h1>Slack</h1>
                    </div>
                </div>
            </div>
        </header>
        <!-- POPUP DE LOGOUT -->
        <div class="popup-logout" style="display: none;" id="popup-logout">
            <div class="popup-content">
                <i class="bi bi-x-lg" onclick="fecharPopup()"></i>
                <h1>Deseja Sair?</h1>
                <div class="box-button">
                    <button> <a href="../../index.html">Fazer Logout</a></button>
                </div>
            </div>
        </div>
        <!-- DASHBOARD -->
        <div class="dashboard" id="dashboard-agenda" style="display: block;">
            <div class="information">
                <div id="titulo">
                    <h1>Agenda Diária</h1>
                </div>
            </div>
            <div id="conteudo-dash-agenda">
                <div class="nenhumaManutencao" id="nenhumaManutencao"></div>
                <div class="kpis" id="kpi-agenda">
                    <div class="kpi">
                        <div class="titulo">
                            <h1>Manutenções totais</h1>
                            <h2> do dia</h2>
                        </div>
                        <div class="dado">
                            <h1 id="dadoTotalManutencoes"></h1>
                        </div>
                    </div>
                    <div class="kpi">
                        <div class="titulo">
                            <h1>Total Manutenções</h1>
                            <h2> concluídas do dia</h2>
                        </div>
                        <div class="dado">
                            <h1 id="dadoManutencoesConcluidas"></h1>
                        </div>
                    </div>
                    <div class="kpi">
                        <div class="titulo">
                            <h1>Total de Manutenções</h1>
                            <h2>pendentes</h2>
                        </div>
                        <div class="dado">
                            <h1 id="dadoManutencoesPendentes"></h1>
                        </div>
                    </div>
                    <div class="kpi">
                        <div class="titulo">
                            <h1>Manutenções de alerta crítico</h1>
                            <h2>pendentes</h2>
                        </div>
                        <div class="dado">
                            <h1 id="dadoManutencoesCriticasPendentes"></h1>
                        </div>
                    </div>
                </div>
                <div class="graficos">
                    <table id="agenda" class="agenda">
                        <tr class="titulo-agenda">
                            <th class="item-titulo-agenda">Id chamado</th>
                            <th class="item-titulo-agenda">MAC</th>
                            <th class="item-titulo-agenda">Local</th>
                            <th class="item-titulo-agenda">Status</th>
                            <th class="item-titulo-agenda">Qtd. Alertas</th>
                            <th class="item-titulo-agenda">Componente crítico</th>
                        </tr>
                        <tr id="conteudo-agenda">
                </div>
                </table>
                <canvas id="agenda-grafico-barras">
                </canvas>
            </div>
        </div>
    </div>
    </div>
    </div>
</body>
<script>
    /* ----------------MENU--------------------- */
    function abrirMenu() {
        menu_icon = document.getElementById('icone');
        menu = document.querySelector('.menu-extend');
        if (menu_icon.classList.contains("bi-list")) {
            console.log("entrei");
            document.getElementById('extend').style.display = "flex";
            menu.style.animation = "expandirDireita 0.5s ease forwards";
            menu_icon.classList.remove("bi-list");
            menu_icon.classList.add("bi-x-lg")

        } else {
            menu.style.animation = "recolherEsquerda 0.5s ease forwards";
            menu_icon.classList.remove("bi-x-lg");
            menu_icon.classList.add("bi-list")
        }
    }
    function ativar(escolha) {
        document.getElementById(escolha).style.display = 'block';
        document.getElementById(escolha).style.animation = 'expandirEsquerda 0.5s ease forwards';
        if (escolha === 'fundo2') {
            document.getElementById("box").style.display = "none";
            document.getElementById("dashboard").style.display = "none";
            document.getElementById("dashboard-agenda").style.display = "none";
            document.getElementById('fundo3').style.animation = 'recolherDireita 0.5s ease forwards';
            document.getElementById('fundo4').style.animation = 'recolherDireita 0.5s ease forwards';
            document.getElementById("second").style.color = "#451c8b";
            document.getElementById("third").style.color = "white";
            document.getElementById("fourth").style.color = "white";
        } else if (escolha === 'fundo3') {
            document.getElementById('fundo2').style.animation = 'recolherDireita 0.5s ease forwards';
            document.getElementById('fundo4').style.animation = 'recolherDireita 0.5s ease forwards';
            document.getElementById("third").style.color = "#451c8b";
            document.getElementById("second").style.color = "white";
            document.getElementById("fourth").style.color = "white";
            document.getElementById("box").style.display = "none";
        } else if (escolha === 'fundo4') {
            document.getElementById('fundo2').style.animation = 'recolherDireita 0.5s ease forwards';
            document.getElementById('fundo3').style.animation = 'recolherDireita 0.5s ease forwards';
            document.getElementById("fourth").style.color = "#451c8b";
            document.getElementById("second").style.color = "white";
            document.getElementById("third").style.color = "white";
            document.getElementById("box").style.display = "none";
        }
    }
    function irPara(escolhida) {
        $("#dashboard-agenda").stop().animate({ opacity: 0 }, 200, function () {
            $(this).css("display", "none");
        });
        $("#" + escolhida).css({ display: "block", opacity: 0 }).stop().animate({ opacity: 1 }, 300);
        carregarDados();
    }
    /* ----------------POP-UP--------------------- */
    function ativarPopup() {
        popup = $("#popup-logout");
        popup.css({ display: "flex", opacity: 0, "pointer-events": "auto" }).animate({ opacity: 1 }, 300);
    }
    function fecharPopup() {
        popup = $("#popup-logout");
        popup.css({ display: "flex", opacity: 0, "pointer-events": "none" }).animate({ opacity: 0 }, 300);
    }
    /* ----------------JIRA--------------------- */
    function visualizarChamadosJira() {
        const emailTecnico = sessionStorage.getItem("EMAIL_USUARIO");
        console.log("ENTREI NA VISUALIZAR CHAMADOS")

        fetch(`/visualizarChamadosJira?EMAIL_USUARIO=${emailTecnico}`)
            .then(res => {
                console.log("FUNCIONOU")
                return res.json();
            })
            .then(dados => {
                if (dados.issues.length == 0 || !dados) {
                    nenhumChamado();
                    return;
                } else {
                    console.log("Chamados:", dados);
                    /*INSERINDO DADOS NA KPI DE TOTAL MANUTENCOES*/
                    dadoTotalManutencoes.innerHTML = dados.issues.length;;

                    /*INSERINDO DADOS NA KPI DE MANUTENCOES CONCLUIDAS E MANUTENCOES PENDENTES*/
                    var qtdChamadosConcluidos = 0;
                    var qtdChamadosTotaisEmAberto = 0;
                    var qtdAlertasCriticosEmAberto = 0;
                    for (var i = 0; i < dados.issues.length; i++) {
                        const issue = dados.issues[i];
                        if (dados.issues[i].fields.status.name == "Concluída") {
                            qtdChamadosConcluidos++;
                        } else if (dados.issues[i].fields.status.name == "Aberto") {
                            qtdChamadosTotaisEmAberto++;
                            const criticidade = extrairCriticidade(issue.fields.summary);
                            if (criticidade === "Perigoso" || criticidade === "Muito Perigoso") {
                                qtdAlertasCriticosEmAberto++;
                            }
                        }
                    }
                    dadoManutencoesConcluidas.innerHTML = qtdChamadosConcluidos;
                    dadoManutencoesPendentes.innerHTML = qtdChamadosTotaisEmAberto;
                    dadoManutencoesCriticasPendentes.innerHTML = qtdAlertasCriticosEmAberto;
                    plotarDadosAgenda(dados);
                    graficoBarras(dados);
                }
            })
            .catch(erro => console.error("Erro", erro));

    }
    async function plotarDadosAgenda(dados) {
        conteudoAgenda = document.getElementById('conteudo-agenda');
        conteudoAgenda.innerHTML = '';
        for (var i = 0; i < dados.issues.length; i++) {
            var chamado = dados.issues[i];
            var summary = chamado.fields.summary;
            var mac = extrairMacFromSummary(summary);
            var status = chamado.fields.status.name;

            try {
                var res = await fetch(`/totem/buscarEnderecoTotem/${mac}`);
                if (res.ok) {
                    var endereco = await res.json();
                    var rua = `${endereco.rua}`;
                    var cep = `${endereco.cep}`;
                    var numEndereco = `${endereco.numero}`;
                    var cidade = `${endereco.cidade}`;
                }
            } catch (erro) {
                console.error("Erro ao buscando endereço de totem (plotarDadosAgenda):", erro);
            }
            conteudoAgenda.innerHTML += `<tr class="info-chamados">
                <th>${chamado.key}</th>
                <th>${mac}</th>
                <th>${cep}</th>
                <th>R. ${rua}, ${numEndereco}</th>
                <th>${status}</th>
                </tr>`;
        }
    }
    function extrairCriticidade(summary) {
        if (!summary) return null;

        const niveisCriticidade = ["Atenção", "Perigoso", "Muito Perigoso"]
        summary = summary.toLowerCase();

        for (let i = 0; i < niveisCriticidade.length; i++) {
            const nivel = niveisCriticidade[i];

            if (summary.includes(nivel)) {
                return nivel;
            }
        }
        return 'Chamado criado sem nivel de criticidade';
    }
    function extrairMacFromSummary(summary) {
        if (!summary) return null;

        const match = summary.match(/Totem\s+(\d{15})/i);

        return match ? match[1] : null;
    }
    function extrairMac(dados) {
        for (var i = 0; i < dados.issues.length; i++) {
            const summary = dados.issues[i].fields.summary;

            const mac = extrairMacFromSummary(summary);

            console.log("Chamado:", dados.issues[i].key, "→ MAC:", mac);
            fetch(`/totem/buscarEnderecoTotem/${mac}`)
                .then(res => res.json())
                .then(endereco => {
                    console.log("Endereço:", endereco);
                    console.log(`${endereco.rua}, ${endereco.bairro}, ${endereco.cidade}`);
                })
                .catch(err => console.error("Erro ao buscar endereço:", err));
        }
    }

    function nenhumChamado() {
        nenhumaManutencao.innerHTML = `
        <div class="card-nothing">
                <h1>Sem Registros</h1>
                <p>Caso isto não seja o esperado pelo nosso sistema, considere entrar em contato com nossa equipe de suporte</p>
                <p>Estamos à sua disposição para solucionar seus incidentes e tornar sua experiência verdadeiramente NEXO.</p>
            </div>
        `;
    }
    /* ----------------DASH--------------------- */
    function graficoBarras(dados) {
        const ctx = document.getElementById('agenda-grafico-barras');
        var qtdAtenção = 0;
        var qtdPerigoso = 0;
        var qtdMuitoPerigoso = 0;

        for (let i = 0; i < dados.issues.length; i++) {
            const chamado = dados.issues[i];
            const summary = chamado.fields.summary;
            const criticidade = extrairCriticidade(summary);

            if (criticidade === "Atenção") {
                qtdAtenção++;
            } else if (criticidade === "Perigoso") {
                qtdPerigoso++;
            } else if (criticidade === "Muito Perigoso") {
                qtdMuitoPerigoso++;
            }
        }


        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Atenção', 'Perigoso', 'Muito Perigoso'],
                datasets: [{
                    label: 'Número de alertas por criticidade',
                    data: [qtdAtenção, qtdPerigoso, qtdMuitoPerigoso],
                    borderWidth: 1,
                    backgroundColor: [               
                        'rgba(255, 159, 64, 0.8)',   
                        'rgba(255, 99, 132, 0.8)',  
                        'rgba(139, 0, 0, 0.9)'       
                    ],
                }],

            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

</script>

</html>