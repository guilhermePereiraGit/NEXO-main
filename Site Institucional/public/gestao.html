<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/gestao.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="shortcut icon" href="assets/favicon.ico" type="image/x-icon">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <title>Página de Cadastro de Usuários</title>
</head>

<body onload="carregarDadosAprovados(),carregarEstados()">
    <div class="container">
        <div class="nav-bar">
            <div class="sair" style="margin-top: 40px;">
                <div class="fundo" style="display: none;"></div>
                <i class="bi bi-box-arrow-left" onclick="ativarPopup()" style="color: white;"></i>
            </div>
        </div>
        <div class="main">
            <div class="topo">
                <h2 style="margin-left: 70px;">Usuários Cadastrados</h2>
                <button onclick="abrirCadastro()" style="margin-right: 70px;">Adicionar Usuário</button>
            </div>
            <div class="baixo">
                <div class="conteudo">
                    <div class="div_aprovados" id="div_aprovados">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- POPUP DE LOGOUT -->
    <div class="popup-logout" style="display: none;" id="popup-logout">
        <div class="popup-content">
            <i class="bi bi-x-lg" onclick="fecharPopup()" style="color: #451c8b;"></i>
            <h1>Deseja Sair?</h1>
            <div class="box-button">
                <button onclick="window.location.href = 'login.html'">Fazer Logout</button>
            </div>
        </div>
    </div>

    <!-- POPUP DE APROVAÇÃO -->
    <div class="popup-aprovado" style="display: none;" id="popup-aprovado">
        <div class="aprovado-content">
            <h1>Cadastro Realizado!</h1>
            <i class="bi bi-check-circle"></i>
        </div>
    </div>

    <!-- POPUP DE INFORMAÇÕES -->
    <div class="popup-infos" style="display: none;" id="popup-infos">
        <div class="infos-content">
            <div class="up">
                <h1>Informações do Funcionário:</h1>
                <i class="bi bi-x-lg" onclick="fecharInfos()"></i>
            </div>
            <div class="infos-dados">
                <div class="part">
                    
                </div>
            </div>
        </div>
    </div>

    <div class="popup-cadastro" id="popup-cadastro" style="display: none;">
        <div class="cadastro-content">
            <i class="bi bi-x-lg" onclick="fecharCadastro()"></i>
            <h1 style="text-align: center; margin-bottom: 20px;">Cadastro de Funcionário</h1>

            <div class="infos">
                <div class="infos-first">
                    <div class="drop">
                        <h2>Nome</h2>
                        <input type="text" id="input_nome">
                    </div>
                    <div class="drop">
                        <h2>Email</h2>
                        <input type="text" id="input_email">
                    </div>
                </div>
                <div class="infos-second">
                    <div class="drop">
                        <h2>CPF</h2>
                        <input type="text" id="input_cpf">
                    </div>
                    <div class="drop">
                        <h2>Telefone</h2>
                        <input type="text" id="input_telefone">
                    </div>
                </div>
                <h1 style="margin-top: 20px;">Informações de Atuação:</h1>
                <div class="infos-third">
                    <div class="drop">
                        <h2>Cargo</h2>
                        <select name="cargos" id="cargos" onchange="ativarOpcao1()">
                            <option value="">Escolha uma opção</option>
                            <option value="Gestor">Gestor</option>
                            <option value="Técnico">Técnico</option>
                        </select>
                    </div>
                    <div class="drop">
                        <h2>Estado</h2>
                        <select name="estado_atuacao" id="estado_atuacao"
                            onchange="atualizarCampos();ativarOpcao2()"></select>
                    </div>
                    <div class="drop">
                        <h2>Região</h2>
                        <select name="regiao_atuacao" id="regiao_atuacao" onchange="procurarZonas()"></select>
                    </div>
                    <div class="drop">
                        <h2>Zona</h2>
                        <select name="zona_atuacao" id="zona_atuacao"></select>
                    </div>
                </div>
                <div class="infos-final">
                    <div class="drop">
                        <h2>Senha</h2>
                        <div class="drop-passwd">
                            <input type="text" id="input_senha">
                            <button class="gerar-senha" onclick="gerarSenha()">Gerar Senha</button>
                        </div>
                    </div>
                    <div class="drop">
                        <button class="cadastrar" onclick="cadastrarFuncionario()">Cadastrar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

<script>
    function ativarOpcao1() {
        popup = $("#estado_atuacao");
        popup.css({ opacity: 0, "pointer-events": "auto" }).animate({ opacity: 1 }, 300);
    }
    function ativarOpcao2() {
        popup = $("#regiao_atuacao");
        popup.css({ opacity: 0, "pointer-events": "auto" }).animate({ opacity: 1 }, 300);
    }

    aprovados = [];
    function carregarDadosAprovados() {
        var idEmpresa = sessionStorage.getItem("ID_EMPRESA");

        fetch("/usuarios/verificarAprovados", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                idEmpresaServer: idEmpresa
            }),
        }).then(function (resposta) {
            console.log(resposta);

            if (resposta.ok) {
                resposta.json().then(data => {
                    aprovados = data;
                    if (aprovados.length > 0) {
                        gerarCardsUsuarios();
                    } else {
                        nadaPorAquiUsuarios();
                    }
                });


            } else {
                console.log("Erro ao Buscar Dados!");
            }
        });
    }

    function nadaPorAquiUsuarios() {
        div_aprovados.innerHTML = `
            <div class="nada">
                <h1>Nenhum Usuário Cadastrado</h1>
            <p>Ao cadastrar um usuário, o cadastro com informações aparecerão aqui.</p>
            <img src="assets/imgs/icon-nexo.png" class="img-nexo">
            </div>
        `;
    }

    function abrirInfos(funcionario) {
        infos = $("#popup-infos");
        infos.css({ display: "flex", opacity: 0, "pointer-events": "auto" }).animate({ opacity: 1 }, 300);
    }

    function fecharInfos() {
        infos = $("#popup-infos");
        infos.css({ display: "flex", opacity: 1, "pointer-events": "none" }).animate({ opacity: 0 }, 300);
    }

    function gerarCardsUsuarios() {
        div_aprovados.innerHTML = "";
        for (var i = 0; i < aprovados.length; i++) {
            user = aprovados[i];
            card = ``;

            card = `<div class="aprove-card" onclick="abrirInfos(${i})">
                        <div class="block">
                            <div class="item">
                                <label class="t">Nome:</label>
                                <label>${user.nome}</label>
                            </div>
                            <div class="item">
                                <label class="t">Email:</label>
                                <label>${user.email}</label>
                            </div>
                        </div>
                        <div class="block">
                            <div class="item">
                                <label class="t">Cargo:</label>
                                <label>${user.cargo}</label>
                            </div>
                            <div class="item">
                                <label class="t">Telefone:</label>
                                <label>${user.telefone}</label>
                            </div>
                        </div>
                    </div>`;
            div_aprovados.innerHTML += card;
        }
    }


    var estados = []
    function carregarEstados() {
        fetch("/endereco/buscarEstados", {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            },
        })
            .then(function (resposta) {

                if (resposta.ok) {
                    resposta.json().then(data => {
                        estados = data;
                        plotarEstadosSelect(estados)
                    })
                } else {
                    console.log("Erro ao Buscar Dados!");
                }
            });
    }

    function plotarEstadosSelect(estados) {
        var option = `<option value="">Selecione uma opção</option>`;

        for (var i = 0; i < estados.length; i++) {
            option += `<option value="${estados[i].IdEstado}">${estados[i].Nome}</option>`;
        }

        estado_atuacao.innerHTML = option;
    }

    var regioes = [];
    function atualizarCampos() {
        var selectEstado = document.getElementById("estado_atuacao");
        var labelSelecionada = selectEstado.options[selectEstado.selectedIndex].text;
        const estado = estado_atuacao.value;
        const cargo = cargos.value;
        const regiaoContainer = regioes;
        const zonaContainer = zonas;

        fetch("/endereco/buscarRegioes", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                idEstadoServer: estado
            }),
        })
            .then(function (resposta) {
                if (resposta.ok) {
                    resposta.json().then(data => {
                        console.log(data);
                        regioes = data;
                        plotarRegioesSelect(regioes);
                    })
                } else {
                    console.log("Erro ao Buscar Dados!");
                }
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
    }

    function plotarRegioesSelect(regioes) {
        var option = `<option value="">Selecione uma opção</option>`;

        for (var i = 0; i < regioes.length; i++) {
            option += `<option value="${regioes[i].IdRegiao}">${regioes[i].Nome}</option>`;
        }

        regiao_atuacao.innerHTML = option;
    }

    var zonas = []
    function procurarZonas() {
        var cargo = cargos.value;

        if (cargo == "Técnico") {
            var selectRegiao = document.getElementById("regiao_atuacao");
            var labelSelecionada = selectRegiao.options[selectRegiao.selectedIndex].text;
            const regiao = regiao_atuacao.value;

            popup = $("#zona_atuacao");
            popup.css({ opacity: 0, "pointer-events": "auto" }).animate({ opacity: 1 }, 300);

            fetch("/endereco/buscarZonas", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    idRegiaoServer: regiao
                }),
            })
                .then(function (resposta) {
                    if (resposta.ok) {
                        resposta.json().then(data => {
                            zonas = data;
                            if (zonas.length > 0) {
                                plotarZonasSelect(zonas);
                            } else {
                                zona_atuacao.innerHTML = "";
                            }
                        })
                    } else {
                        console.log("Erro ao Buscar Dados!");
                    }
                })
                .catch(function (resposta) {
                    console.log(`#ERRO: ${resposta}`);
                });
        }
    }

    function plotarZonasSelect(zonas) {
        var option = `<option value="">Selecione uma opção</option>`;

        for (var i = 0; i < zonas.length; i++) {
            option += `<option value="${zonas[i].IdZona}">${zonas[i].Nome}</option>`;
        }

        zona_atuacao.innerHTML = option;
    }

    function cadastrarFuncionario() {
        var nome = input_nome.value;
        var email = input_email.value;
        var cpf = input_cpf.value;
        var telefone = input_telefone.value;
        var senha = input_senha.value;
        var estadoAtuacao = estado_atuacao.value;
        var zonaAtuacao = zona_atuacao.value;
        var regiaoAtuacao = regiao_atuacao.value;
        var cargo = cargos.value
        var idEmpresa = sessionStorage.getItem("ID_EMPRESA");

        fetch("/usuarios/cadastrarFuncionario", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                nomeServer: nome,
                emailServer: email,
                senhaServer: senha,
                cpfServer: cpf,
                telefoneServer: telefone,
                cargoServer: cargo,
                regiaoAtuacaoServer: regiaoAtuacao,
                estadoAtuacaoServer: estadoAtuacao,
                zonaAtuacaoServer: zonaAtuacao,
                fkEmpresa: idEmpresa
            }),
        })
            .then(function (resposta) {
                console.log("resposta: ", resposta);

                if (resposta.ok) {
                    aprovado = $('#popup-aprovado');
                    aprovado.css({ display: "flex", opacity: 0 }).animate({ opacity: 1 }, 300);

                    setTimeout(() => {
                        aprovado.css({ display: "flex", opacity: 1 }).animate({ opacity: 0 }, 300);
                        fecharCadastro();
                    }, 2000);

                    input_nome.value = "";
                    input_email.value = "";
                    input_cpf.value = "";
                    input_senha.value = "";
                    input_telefone.value = "";
                    cargos.value = "";

                } else {
                    resposta.innerHTML = "Erro ao Logar"
                }
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
        return false;
    }

    function limparFuncionarios(id) {
        var idUsuario = id;

        if (
            idUsuario == ""
        ) {
            return false;
        }

        fetch("/usuarios/deletarFuncionario", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                idUsuarioServer: idUsuario
            }),
        })
            .then(function (resposta) {
                console.log("resposta: ", resposta);

                if (resposta.ok) {
                    window.location.reload()
                } else {
                    console.log("Erro ao Deletar");

                }
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
        return false;
    }

    function gerarSenha() {
        const teclado = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
        var senhaAleatoria = "";
        for (var i = 0; i < 20; i++) {
            var indice = Math.floor(Math.random() * teclado.length); senhaAleatoria
                += teclado[indice];
        } document.getElementById("input_senha").value = senhaAleatoria;
    }

    function abrirCadastro() {
        popup = $("#popup-cadastro");
        popup.css({ display: "flex", opacity: 0, "pointer-events": "auto" }).animate({ opacity: 1 }, 300);
    }
    function fecharCadastro() {
        popup = $("#popup-cadastro");
        popup.css({ display: "flex", opacity: 1, "pointer-events": "none" }).animate({ opacity: 0 }, 300);
        setTimeout(() => {
            window.location.reload();
        }, 1000)
    }

    function ativarPopup() {
        popup = $("#popup-logout");
        popup.css({ display: "flex", opacity: 0, "pointer-events": "auto" }).animate({ opacity: 1 }, 300);
    }
    function fecharPopup() {
        popup = $("#popup-logout");
        popup.css({ display: "flex", opacity: 1, "pointer-events": "none" }).animate({ opacity: 0 }, 300);
    }

</script>

</html>