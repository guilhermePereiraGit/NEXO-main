<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/gestao.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="shortcut icon" href="assets/favicon.ico" type="image/x-icon">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <title>Página de Cadastro de Usuários</title>
</head>

<body onload="carregarDadosAprovados(),carregarEstados()">
    <div class="container">
        <div class="nav-bar">
            <div class="sair" style="margin-top: 40px;">
                <div class="fundo" style="display: none;"></div>
                <i class="bi bi-box-arrow-left" onclick="ativarPopup()" style="color: white;"></i>
            </div>
        </div>
        <div class="main">
            <div class="topo">
                <h2 style="margin-left: 70px;">Usuários Cadastrados</h2>
                <button onclick="abrirCadastro()" style="margin-right: 70px;">Adicionar Usuário</button>
            </div>
            <div class="baixo">
                <div class="conteudo">
                    <div class="div_aprovados" id="div_aprovados">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- POPUP DE LOGOUT -->
    <div class="popup-logout" style="display: none;" id="popup-logout">
        <div class="popup-content">
            <i class="bi bi-x-lg" onclick="fecharPopup()" style="color: #451c8b;"></i>
            <h1>Deseja Sair?</h1>
            <div class="box-button">
                <button onclick="window.location.href = 'login.html'">Fazer Logout</button>
            </div>
        </div>
    </div>

    <!-- POPUP DE APROVAÇÃO -->
    <div class="popup-aprovado" style="display: none;" id="popup-aprovado">
        <div class="aprovado-content">
            <h1>Cadastro Realizado!</h1>
            <i class="bi bi-check-circle"></i>
        </div>
    </div>

    <!-- POPUP DE INFORMAÇÕES -->
    <div class="popup-infos" style="display: none;" id="popup-infos">
        <div class="infos-content">
            <div class="up">
                <h1 style="color: black;">Informações do Funcionário <span id="spn_cargo"
                        style="color: #451c8b;"></span>:</h1>
                <i class="bi bi-x-lg" onclick="fecharInfos()"></i>
            </div>
            <div class="infos-dados">
                <div class="part" id="special">
                    <label>Nome: <span id="spn_nome"></span></label>
                    <label>Email: <span id="spn_email"></span></label>
                    <label>Senha: <span id="spn_senha"></span></label>
                    <label>Estado: <span id="spn_estado"></span></label>
                    <div class="botoes" id="topo">
                    </div>
                </div>
                <div class="part regioes">
                    <h1>Regiões Associadas:</h1>
                    <div class="regioes-user" id="regioes_user">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="popup-cadastro" id="popup-cadastro" style="display: none;">
        <div class="cadastro-content">
            <i class="bi bi-x-lg" onclick="fecharCadastro()"></i>
            <h1 style="text-align: center; margin-bottom: 20px;">Cadastro de Funcionário</h1>

            <div class="infos">
                <div class="infos-first">
                    <div class="drop">
                        <h2>Nome</h2>
                        <input type="text" id="input_nome">
                    </div>
                    <div class="drop">
                        <h2>Email</h2>
                        <input type="text" id="input_email">
                    </div>
                </div>
                <div class="infos-second">
                    <div class="drop">
                        <h2>CPF</h2>
                        <input type="text" id="input_cpf">
                    </div>
                    <div class="drop">
                        <h2>Telefone</h2>
                        <input type="text" id="input_telefone">
                    </div>
                </div>
                <h1 style="margin-top: 20px;">Informações de Atuação:</h1>
                <div class="infos-third">
                    <div class="drop">
                        <h2>Cargo</h2>
                        <select name="cargos" id="cargos" onchange="ativarOpcao1()">
                            <option value="">Escolha uma opção</option>
                            <option value="Gestor">Gestor</option>
                            <option value="Técnico">Técnico</option>
                        </select>
                    </div>
                    <div class="drop">
                        <h2>Estado</h2>
                        <select name="estado_atuacao" id="estado_atuacao"
                            onchange="atualizarCampos();ativarOpcao2()"></select>
                    </div>
                    <div class="drop">
                        <h2>Região</h2>
                        <select name="regiao_atuacao" id="regiao_atuacao" onchange="procurarZonas()"></select>
                    </div>
                    <div class="drop">
                        <h2>Zona</h2>
                        <select name="zona_atuacao" id="zona_atuacao"></select>
                    </div>
                </div>
                <div class="infos-final">
                    <div class="drop">
                        <h2>Senha</h2>
                        <div class="drop-passwd">
                            <input type="text" id="input_senha">
                            <button class="gerar-senha" onclick="gerarSenha()">Gerar Senha</button>
                        </div>
                    </div>
                    <div class="drop">
                        <button class="cadastrar" onclick="cadastrarFuncionario()">Cadastrar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

<script>
    function alterarZona(zona) {
        document.getElementById(`${zona}`).innerHTML = `<select name="zona_mudar" id="zona_mudar"></select>`
        var option = `<option value="">Selecione uma opção</option>`;

        for (var i = 1; i < zonas_mudar.length; i++) {
            option += `<option value="${zonas_mudar[i].idZona}">${zonas_mudar[i].nomeZona}</option>`;
        }
        zona_mudar.innerHTML = option;
        document.getElementById(`${zona}`).innerHTML += `<button id='update'><i class='bi bi-bookmark-check' id='teste' onclick='alterarFinal()'></i></button>`

    }
    function alterarFinal() {
        nova_zona = document.getElementById('zona_mudar').value;
        console.log(nova_zona);

        for (let i = 0; i < zonas_mudar.length; i++) {
            if (zonas_mudar[i].idZona == nova_zona) {
                metricas = {
                    idZona: zonas_mudar[i].idZona,
                    idRegiao: zonas_mudar[i].idRegiao,
                    idUsuario: sessionStorage.getItem('USUARIO_ESCOLHIDO'),
                    novaZona: nova_zona
                };

                fetch("/regiao/alterar", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        alterar_itens: metricas
                    }),
                })
            }
        }
        window.location.reload();
    }

    function ativarOpcao1() {
        popup = $("#estado_atuacao");
        popup.css({ opacity: 0, "pointer-events": "auto" }).animate({ opacity: 1 }, 300);
    }
    function ativarOpcao2() {
        popup = $("#regiao_atuacao");
        popup.css({ opacity: 0, "pointer-events": "auto" }).animate({ opacity: 1 }, 300);
    }

    aprovados = [];
    function carregarDadosAprovados() {
        var idEmpresa = sessionStorage.getItem("ID_EMPRESA");

        fetch("/usuarios/verificarAprovados", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                idEmpresaServer: idEmpresa
            }),
        }).then(function (resposta) {
            console.log(resposta);

            if (resposta.ok) {
                resposta.json().then(data => {
                    aprovadosNew = data;
                    console.log(aprovados);

                    if (aprovadosNew.length > 0) {
                        gerarCardsUsuarios();
                    } else {
                        nadaPorAquiUsuarios();
                    }
                });


            } else {
                console.log("Erro ao Buscar Dados!");
            }
        });
    }

    function nadaPorAquiUsuarios() {
        div_aprovados.innerHTML = `
            <div class="nada">
                <h1>Nenhum Usuário Cadastrado</h1>
            <p>Ao cadastrar um usuário, o cadastro com informações aparecerão aqui.</p>
            <img src="assets/imgs/icon-nexo.png" class="img-nexo">
            </div>
        `;
    }

    function abrirInfos(funcionario) {
        infos = $("#popup-infos");
        infos.css({ display: "flex", opacity: 0, "pointer-events": "auto" }).animate({ opacity: 1 }, 300);
        console.log(userIndividual);


        //spn_cargo,spn_nome,spn_email,spn_senha,spn_estado
        spn_cargo.innerHTML = userIndividual[funcionario].cargo
        spn_nome.innerHTML = userIndividual[funcionario].nome
        spn_email.innerHTML = userIndividual[funcionario].email
        spn_estado.innerHTML = userIndividual[funcionario].NomeEstado
        spn_senha.innerHTML = userIndividual[funcionario].senha
        sessionStorage.setItem("USUARIO_ESCOLHIDO", userIndividual[funcionario].idUsuario)
        regioes_user.innerHTML = "";

        prim_usuario = userIndividual[funcionario];
        prim_id_user = prim_usuario.idUsuario;
        let ultimaRegiaoDoUsuario = null;

        let identificadorZona = 1;
        let corpo = "";
        for (var i = 0; i < aprovadosNew.length; i++) {
            usuario = aprovadosNew[i];

            if (usuario.idUsuario == prim_id_user) {
                ultimaRegiaoDoUsuario = usuario;

                regiao = usuario.NomeRegiao.replace("Região Metropolitana de", "");
                zona = usuario.NomeZona;
                console.log(regiao);

                corpo += `
                    <div class="regiao">
                        <div class="name">
                            <h1>Região</h1>
                            <p>RM ${regiao}</p>
                        </div>
                        <div class="zona">
                            <h1>Zona</h1>
                            <p id="ipt_zona_${identificadorZona}">${zona}</p>
                        </div>
                        <div class="manipulacao">
                            <i class="bi bi-trash3" onclick="excluirRegiao(${usuario.idRegiao},${usuario.idUsuario})"></i>
                            
                `;

                if (zona != "Nenhum") {
                    corpo += `
                            <i class="bi bi-arrow-repeat" onclick="alterarZona('ipt_zona_${identificadorZona}')" id="btn_alt_${identificadorZona}"></i>
                    `;
                }
                corpo += `
                </div>
                </div>
                `;
                identificadorZona++;

                regioes_user.innerHTML = corpo;
            }

        }
        topo.innerHTML = `
        <button onclick="adicionarRegiao(${userIndividual[funcionario].idUsuario})">Adicionar Região</button>
        <button onclick="limparFuncionarios(${userIndividual[funcionario].idUsuario})">Cancelar Usuário</button>`;
        if (ultimaRegiaoDoUsuario) {
            console.log(ultimaRegiaoDoUsuario);
            guardarZonas(ultimaRegiaoDoUsuario.idRegiao);
            alterarFinal(ultimaRegiaoDoUsuario.idRegiao);
        } else {
            console.warn("Nenhuma região encontrada para este usuário.");
        }
    }

    function excluirRegiao(regiao, usuario) {
        fetch("/regiao/excluirArea", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                regiao: regiao,
                usuario: usuario
            }),
        })
            .then(function (resposta) {
                if (resposta.ok) {
                    console.log("Deletado com Sucesso!");
                    
                } else {
                    console.log("Erro ao Deletar Dados!");
                }
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
            window.location.reload();
    }

    function adicionarRegiao(usuario) {
        carregarDadosAprovados()
        usuario_escolhido = sessionStorage.getItem('USUARIO_ESCOLHIDO');
        for (var i = 0; i < aprovados.length; i++) {
            if (aprovados[i].idUsuario == usuario_escolhido) {
                estado = aprovados[i].IdEstado;
            }
        }

        fetch("/endereco/buscarRegioes", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                idEstadoServer: estado
            }),
        })
            .then(function (resposta) {
                if (resposta.ok) {
                    resposta.json().then(data => {
                        console.log(data);
                        regioes = data;
                        plotarRegioesSelect(regioes);
                    })
                } else {
                    console.log("Erro ao Buscar Dados!");
                }
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });

        regioes_user.innerHTML += `
            <div class="regiao">
            <div class="name">
            <h1>Região</h1>
            <select name="regiao_atuacao_adicionar" class="reg_adicionar" id="regiao_atuacao_adicionar" onchange="plotarZonasAdicionar()"></select>
            </div>
            <div class="zona">
            <h1 id="tit_zona">Zona</h1>
            <select name="zona_atuacao_adicionar" class="zon_adicionar" id="zona_atuacao_adicionar"></select>
            </div>
            <button class="btn_adicionar" onclick="adicionarRegiaoFinal()">+</button>
            <div class="manipulacao">
            <i class="bi bi-trash3" id="excluir"></i>
            <i class="bi bi-arrow-repeat" id="alterar" onclick="alterarZona('ipt_zona1')"></i>
            </div>
            </div>
            `;
    }

    function adicionarRegiaoFinal() {
        carregarDadosAprovados()
        // ENCONTRAR FUNCIONARIO
        for (var i = 0; i < aprovados.length; i++) {
            if (aprovados[i].idUsuario == sessionStorage.getItem('USUARIO_ESCOLHIDO')) {
                cargo = aprovados[i].cargo;
                usuario = aprovados[i].idUsuario;
                zona = zona_atuacao_adicionar.value;
                regiao = regiao_atuacao_adicionar.value;
            }
        }
        if (zona == "" || zona == null || zona == undefined) { zona = 1 };
        console.log("Zona", zona);
        console.log("Regiao", regiao);
        console.log("Usuario", usuario);



        fetch("/adicionarRegiao/cadastrarEndZona", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                retornoIdZona: zona,
                retornoIdUsuario: usuario,
                retornoIdRegiao: regiao
            }),
        })
            .then(function (resposta) {
                console.log("resposta: ", resposta);

                if (resposta.ok) {
                    console.log("Cadastro com Sucesso");
                    window.location.reload();
                } else {
                    console.log("Cadastro Falhou");
                }
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
    }

    function plotarZonasAdicionar() {
        console.log("entrei");

        regiao = regiao_atuacao_adicionar.value;
        fetch("/endereco/buscarZonas", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                idRegiaoServer: regiao
            }),
        })
            .then(function (resposta) {
                if (resposta.ok) {
                    resposta.json().then(data => {
                        zonas = data;
                        if (zonas.length > 0) {
                            console.log(zonas);
                            zona_atuacao_adicionar.style.display = 'block';
                            tit_zona.style.display = 'block';
                            plotarZonasSelect(zonas);
                        } else {
                            zona_atuacao_adicionar.style.display = 'none';
                            tit_zona.style.display = 'none';
                        }
                    })
                } else {
                    console.log("Erro ao Buscar Dados!");
                }
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
    }

    zonas_mudar = [];
    function guardarZonas(regiao) {
        console.log("REGIÃO RECEBIDA:", regiao);

        fetch("/regiao/guardar", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                idRegiao: regiao
            }),
        })
            .then(function (resposta) {
                if (resposta.ok) {
                    resposta.json().then(data => {
                        zonas_mudar = data;
                        console.log('oie');
                        console.log(zonas_mudar);

                    })
                } else {
                    console.log("Erro ao Buscar Dados!");
                }
            });
    }

    function fecharInfos() {
        infos = $("#popup-infos");
        infos.css({ display: "flex", opacity: 1, "pointer-events": "none" }).animate({ opacity: 0 }, 300);
    }

    function gerarCardsUsuarios() {
        div_aprovados.innerHTML = "";
        userIndividual = [];
        for (var i = 0; i < aprovadosNew.length; i++) {
            user = aprovadosNew[i];
            igual = false;

            //For para ver se ele tem mais de uma região ou zona
            for (var j = 0; j < userIndividual.length; j++) {
                if (userIndividual[j].idUsuario == user.idUsuario) {
                    igual = true;
                    break;
                }
            }
            if (!igual) {
                userIndividual.push(user)
            }
        }

        for (var i = 0; i < userIndividual.length; i++) {
            user = userIndividual[i];

            card = `<div class="aprove-card" onclick="abrirInfos(${i})">
                        <div class="block">
                            <div class="item">
                                <label class="t">Nome:</label>
                                <label>${user.nome}</label>
                            </div>
                            <div class="item">
                                <label class="t">Email:</label>
                                <label>${user.email}</label>
                            </div>
                        </div>
                        <div class="block">
                            <div class="item">
                                <label class="t">Cargo:</label>
                                <label>${user.cargo}</label>
                            </div>
                            <div class="item">
                                <label class="t">Telefone:</label>
                                <label>${user.telefone}</label>
                            </div>
                        </div>
                    </div>`;
            div_aprovados.innerHTML += card;
        }
        aprovados = userIndividual;
    }

    var estados = []
    function carregarEstados() {
        fetch("/endereco/buscarEstados", {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            },
        })
            .then(function (resposta) {

                if (resposta.ok) {
                    resposta.json().then(data => {
                        estados = data;
                        plotarEstadosSelect(estados)
                    })
                } else {
                    console.log("Erro ao Buscar Dados!");
                }
            });
    }

    function plotarEstadosSelect(estados) {
        var option = `<option value="">Selecione uma opção</option>`;

        for (var i = 0; i < estados.length; i++) {
            option += `<option value="${estados[i].IdEstado}">${estados[i].Nome}</option>`;
        }

        estado_atuacao.innerHTML = option;
    }

    var regioes = [];
    function atualizarCampos() {
        var selectEstado = document.getElementById("estado_atuacao");
        var labelSelecionada = selectEstado.options[selectEstado.selectedIndex].text;
        const estado = estado_atuacao.value;
        const cargo = cargos.value;
        const regiaoContainer = regioes;
        const zonaContainer = zonas;

        fetch("/endereco/buscarRegioes", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                idEstadoServer: estado
            }),
        })
            .then(function (resposta) {
                if (resposta.ok) {
                    resposta.json().then(data => {
                        console.log(data);
                        regioes = data;
                        plotarRegioesSelect(regioes);
                    })
                } else {
                    console.log("Erro ao Buscar Dados!");
                }
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
    }

    function plotarRegioesSelect(regioes) {
        var option = `<option value="">Selecione uma opção</option>`;

        for (var i = 0; i < regioes.length; i++) {
            option += `<option value="${regioes[i].IdRegiao}">${regioes[i].Nome}</option>`;
        }

        regiao_atuacao.innerHTML = option;
        regiao_atuacao_adicionar.innerHTML = option;
    }

    var zonas = []
    function procurarZonas() {
        var cargo = cargos.value;

        if (cargo == "Técnico") {
            var selectRegiao = document.getElementById("regiao_atuacao");
            var labelSelecionada = selectRegiao.options[selectRegiao.selectedIndex].text;
            const regiao = regiao_atuacao.value;

            popup = $("#zona_atuacao");
            popup.css({ opacity: 0, "pointer-events": "auto" }).animate({ opacity: 1 }, 300);

            fetch("/endereco/buscarZonas", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    idRegiaoServer: regiao
                }),
            })
                .then(function (resposta) {
                    if (resposta.ok) {
                        resposta.json().then(data => {
                            zonas = data;
                            if (zonas.length > 0) {
                                plotarZonasSelect(zonas);
                            } else {
                                zona_atuacao.innerHTML = "";
                            }
                        })
                    } else {
                        console.log("Erro ao Buscar Dados!");
                    }
                })
                .catch(function (resposta) {
                    console.log(`#ERRO: ${resposta}`);
                });
        }
    }

    function plotarZonasSelect(zonas) {
        var option = `<option value="">Selecione uma opção</option>`;

        for (var i = 1; i < zonas.length; i++) {
            option += `<option value="${zonas[i].IdZona}">${zonas[i].Nome}</option>`;
        }

        zona_atuacao.innerHTML = option;
        zona_atuacao_adicionar.innerHTML = option;
    }

    function cadastrarFuncionario() {
        var nome = input_nome.value;
        var email = input_email.value;
        var cpf = input_cpf.value;
        var telefone = input_telefone.value;
        var senha = input_senha.value;
        var estadoAtuacao = estado_atuacao.value;
        var zonaAtuacao = zona_atuacao.value;
        var regiaoAtuacao = regiao_atuacao.value;
        var cargo = cargos.value
        var idEmpresa = sessionStorage.getItem("ID_EMPRESA");

        fetch("/usuarios/cadastrarFuncionario", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                nomeServer: nome,
                emailServer: email,
                senhaServer: senha,
                cpfServer: cpf,
                telefoneServer: telefone,
                cargoServer: cargo,
                regiaoAtuacaoServer: regiaoAtuacao,
                estadoAtuacaoServer: estadoAtuacao,
                zonaAtuacaoServer: zonaAtuacao,
                fkEmpresa: idEmpresa
            }),
        })
            .then(function (resposta) {
                console.log("resposta: ", resposta);

                if (resposta.ok) {
                    aprovado = $('#popup-aprovado');
                    aprovado.css({ display: "flex", opacity: 0 }).animate({ opacity: 1 }, 300);

                    setTimeout(() => {
                        aprovado.css({ display: "flex", opacity: 1 }).animate({ opacity: 0 }, 300);
                        fecharCadastro();
                    }, 2000);

                    input_nome.value = "";
                    input_email.value = "";
                    input_cpf.value = "";
                    input_senha.value = "";
                    input_telefone.value = "";
                    cargos.value = "";

                } else {
                    resposta.innerHTML = "Erro ao Logar"
                }
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
        return false;
    }

    function limparFuncionarios(id) {
        var idUsuario = id;

        if (
            idUsuario == ""
        ) {
            return false;
        }

        fetch("/usuarios/deletarFuncionario", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                idUsuarioServer: idUsuario
            }),
        })
            .then(function (resposta) {
                console.log("resposta: ", resposta);

                if (resposta.ok) {
                    window.location.reload()
                } else {
                    console.log("Erro ao Deletar");

                }
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
        return false;
    }

    function gerarSenha() {
        const teclado = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
        var senhaAleatoria = "";
        for (var i = 0; i < 20; i++) {
            var indice = Math.floor(Math.random() * teclado.length); senhaAleatoria
                += teclado[indice];
        } document.getElementById("input_senha").value = senhaAleatoria;
    }

    function abrirCadastro() {
        popup = $("#popup-cadastro");
        popup.css({ display: "flex", opacity: 0, "pointer-events": "auto" }).animate({ opacity: 1 }, 300);
    }
    function fecharCadastro() {
        popup = $("#popup-cadastro");
        popup.css({ display: "flex", opacity: 1, "pointer-events": "none" }).animate({ opacity: 0 }, 300);
        setTimeout(() => {
            window.location.reload();
        }, 1000)
    }

    function ativarPopup() {
        popup = $("#popup-logout");
        popup.css({ display: "flex", opacity: 0, "pointer-events": "auto" }).animate({ opacity: 1 }, 300);
    }
    function fecharPopup() {
        popup = $("#popup-logout");
        popup.css({ display: "flex", opacity: 1, "pointer-events": "none" }).animate({ opacity: 0 }, 300);
    }
</script>

</html>